<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Suivi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    // --- SECURITY FIX: Fonction d'échappement XSS (Ajouté par script) ---
    window.escapeHTML = function(str) {
        if (str === null || str === undefined) return '';
        // Si c'est déjà un objet sécurisé ou un nombre, on retourne tel quel
        if (typeof str === 'number') return str;
        
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    };
</script>
    <script>
        // Configuration Globale
        // --- CORRIGÉ : Déclaration vide. Les paramètres sont chargés depuis Firestore via appSettings.
        const CATEGORIES = {};
    // --- NOUVELLES VARIABLES GLOBALES ---
    window.selectedCollab = "";

    // --- FONCTIONS FILTRES ---
    window.setCollabFilter = function(val) {
        window.selectedCollab = val;
        // Reset pagination
        if(window.histState) window.histState.currentPage = 1;
        
        // Refresh vues
        const currentView = document.getElementById('btn-dashboard').classList.contains('bg-[#fef8f3]') ? 'dashboard' : 
                            document.getElementById('btn-history').classList.contains('bg-[#fef8f3]') ? 'history' : null;
        
        if(currentView === 'dashboard') {
            document.getElementById('app-content').innerHTML = renderDashboard();
            initDashboardCharts();
        } else if (currentView === 'history') {
            refreshHistoryTable();
        }
    };

    // Fonction pour remplir la liste des collabs (Appelée par le listener Firestore)
    window.populateCollabList = function() {
        const select = document.getElementById('filter-collab');
        if(!select) return;
        
        const currentVal = select.value;
        const agents = new Set();
        // On récupère tous les agents uniques
        (window.calls || []).forEach(c => {
            if(c.agentEmail) agents.add(c.agentEmail);
        });
        
        const sortedAgents = Array.from(agents).sort();
        
        let html = '<option value="">Tous les collaborateurs</option>';
        sortedAgents.forEach(a => {
            const name = a.split('@')[0].replace('.', ' ');
            const isSel = a === window.selectedCollab ? 'selected' : '';
            html += `<option value="${a}" ${isSel} class="capitalize">${name}</option>`;
        });
        
        select.innerHTML = html;
    };

    // --- FIX PAGINATION : Attacher globalement ---
    window.changePage = function(delta) {
        if(!window.histState) return;
        window.histState.currentPage += delta;
        window.refreshHistoryTable();
    };
 
        const CENTRES_DB = {};

    // --- GESTION CENTRALISÉE DES COULEURS DE STATUT ---
    window.getStatusBadge = function(status) {
        const s = (status || "").toString();
        // Styles de base
        const base = "px-2 py-1 rounded-full text-xs font-bold border flex items-center w-fit gap-1";
        
        if(s === 'Clôturé') {
            return `<span class="${base} bg-green-100 text-green-700 border-green-200"><i class="ph ph-check-circle"></i> ${window.escapeHTML(s)}</span>`;
        } 
        else if(s === 'En cours') {
            return `<span class="${base} bg-blue-100 text-blue-700 border-blue-200"><i class="ph ph-hourglass"></i> ${window.escapeHTML(s)}</span>`;
        } 
        else if(s === 'À traiter') {
            return `<span class="${base} bg-orange-100 text-orange-700 border-orange-200"><i class="ph ph-wrench"></i> ${window.escapeHTML(s)}</span>`;
        } 
        else if(s === 'À rappeler') {
            return `<span class="${base} bg-yellow-100 text-yellow-700 border-yellow-200"><i class="ph ph-bell-ringing"></i> ${window.escapeHTML(s)}</span>`;
        }
        // Défaut (Gris)
        return `<span class="${base} bg-gray-100 text-gray-600 border-gray-200">${window.escapeHTML(s)}</span>`;
    };
     
        
        window.calls = [];
        window.window.currentUser = null;
        window.appSettings = {
    "Agenda": [
        "paramétrage planning / tarif",
        "paramétrage L",
        "info RDV",
        "info paiement / remboursement",
        "paramétrage promo",
        "gestion multi",
        "bug",
        "autre",
        "paramétrage compte pro"
    ],
    "Box marketing": [
        "Info suivi commande",
        "Info produit",
        "Campagne SMS",
        "Mise à jour info compte",
        "Process retour",
        "Commande kit PLV",
        "Bug",
        "Autre"
    ],
    "RCPC": [
        "process adhésion / résiliation",
        "info stats envoi courrier",
        "paramétrage courrier",
        "Autre"
    ],
    "Lemonway": [
        "création / résiliation / vérification compte",
        "changement MDP",
        "bug paiement en ligne (RDV en attente)",
        "bug lemonway",
        "Autre"
    ],
    "Partenariats": [
        "nationaux",
        "bug athoris",
        "procédure facturation",
        "règlements en attente",
        "Demande autorisation",
        "Autre"
    ],
    "Pilote": [
        "info compte / stats",
        "SMS",
        "géobusiness",
        "avis Google",
        "call center",
        "info facture",
        "site internet",
        "bug",
        "Autre"
    ],
    "SIR": [
        "mise à jour données centre",
        "plan centre",
        "Autre"
    ],
    "Interne service": [
        "création",
        "événementiel",
        "jeux",
        "réseau",
        "Google Ads",
        "communication",
        "presse",
        "GMB",
        "Autre"
    ],
    "Externe service": [
        "comptabilité",
        "qualité",
        "technique",
        "accueil",
        "agrément",
        "genilink",
        "formation",
        "OC",
        "SIV",
        "radar",
        "direction",
        "ACOS",
        "Autre"
    ],
    "Autre": [
        "Autre"
    ]
}; // Applications statiques suite à la suppression du paramétrage
        window.callDirection = null; // Direction de l\'appel (Entrant/Sortant)

        // --- GESTION DES FILTRES DE DATE ---
        window.dateFilter = { mode: 'day', start: null, end: null }; // Par défaut : Mois en cours

        window.setDateFilter = function(mode) {
            window.dateFilter.mode = mode;
            const now = new Date();
            
            // Mise à jour visuelle des boutons (simple gestion de classe)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.mode === mode) {
                    btn.classList.add('bg-orange-100', 'text-orange-600', 'border-orange-200');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
                } else {
                    btn.classList.remove('bg-orange-100', 'text-orange-600', 'border-orange-200');
                    btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
                }
            });

            // Si personnalisé, on lit les inputs
            if (mode === 'custom') {
                const startVal = document.getElementById('filter-start').value;
                const endVal = document.getElementById('filter-end').value;
                if(startVal) window.dateFilter.start = new Date(startVal);
                if(endVal) window.dateFilter.end = new Date(endVal + 'T23:59:59');
            }
            
            // Rafraichir la vue active
            const currentView = document.getElementById('btn-dashboard').classList.contains('bg-[#fef8f3]') ? 'dashboard' : 
                                document.getElementById('btn-history').classList.contains('bg-[#fef8f3]') ? 'history' : null;
            
            if(currentView === 'dashboard') {
                document.getElementById('app-content').innerHTML = renderDashboard();
                initDashboardCharts();
            } else if (currentView === 'history') {
                refreshHistoryTable();
            }
        };

        // Fonction utilitaire pour parser la date format "JJ/MM/AAAA HH:mm:ss"
        window.parseCallDate = function(dateStr) {
            if(!dateStr) return new Date(0);
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/');
            // Reformatage ISO pour JS : YYYY-MM-DDTHH:mm:ss
            return new Date(`${year}-${month}-${day}T${timePart || '00:00:00'}`);
        };

        
        window.getFilteredCalls = function() {
            const mode = window.dateFilter.mode;
            const now = new Date();
            let start = new Date(now);
            let end = new Date(now);

            // Définition des bornes (Logic existante conservée)
            if (mode === 'day') {
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
            } else if (mode === 'week') {
                const day = now.getDay() || 7; 
                if(day !== 1) start.setHours(-24 * (day - 1));
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
            } else if (mode === 'month') {
                start.setDate(1); start.setHours(0,0,0,0);
                end.setMonth(end.getMonth() + 1); end.setDate(0); end.setHours(23,59,59,999);
            } else if (mode === 'year') {
                start.setMonth(0, 1); start.setHours(0,0,0,0);
                end.setMonth(11, 31); end.setHours(23,59,59,999);
            } else if (mode === 'custom') {
                start = window.dateFilter.start || new Date(0);
                end = window.dateFilter.end || new Date(8640000000000000);
            } else {
                // all
                start = new Date(0); end = new Date(8640000000000000);
            }

            return calls.filter(c => {
                const cDate = window.parseCallDate(c.dateCall);
                const dateMatch = cDate >= start && cDate <= end;
                
                // NOUVEAU : Filtre Collaborateur
                const collabMatch = !window.selectedCollab || c.agentEmail === window.selectedCollab;
                
                return dateMatch && collabMatch;
            });
        };


        // Générateur HTML de la barre de filtres
        
        window.renderFilterBar = function() {
            const m = window.dateFilter.mode;
            const cls = (target) => m === target ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-white text-gray-600 border-gray-200';
            
            // On lance le peuplement de la liste au rendu (petit délai pour que le DOM soit prêt)
            setTimeout(window.populateCollabList, 100);

            return `
            <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col xl:flex-row gap-3 items-center justify-between animate-fade-in">
                <div class="flex gap-2 overflow-x-auto w-full xl:w-auto pb-1 xl:pb-0">
                    <button onclick="setDateFilter('day')" data-mode="day" class="filter-btn px-4 py-2 rounded-lg border text-sm font-bold transition-colors whitespace-nowrap ${cls('day')}">Aujourd'hui</button>
                    <button onclick="setDateFilter('week')" data-mode="week" class="filter-btn px-4 py-2 rounded-lg border text-sm font-bold transition-colors whitespace-nowrap ${cls('week')}">Cette Semaine</button>
                    <button onclick="setDateFilter('month')" data-mode="month" class="filter-btn px-4 py-2 rounded-lg border text-sm font-bold transition-colors whitespace-nowrap ${cls('month')}">Ce Mois</button>
                    <button onclick="setDateFilter('year')" data-mode="year" class="filter-btn px-4 py-2 rounded-lg border text-sm font-bold transition-colors whitespace-nowrap ${cls('year')}">Cette Année</button>
                    <button onclick="setDateFilter('all')" data-mode="all" class="filter-btn px-4 py-2 rounded-lg border text-sm font-bold transition-colors whitespace-nowrap ${cls('all')}">Tout</button>
                </div>
                
                <div class="flex flex-col md:flex-row gap-2 w-full xl:w-auto">
                    <div class="relative min-w-[200px]">
                        <i class="ph ph-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <select id="filter-collab" onchange="window.setCollabFilter(this.value)" class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg outline-none text-sm font-medium text-gray-600 cursor-pointer hover:bg-gray-100 transition">
                            <option value="">Chargement...</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>

                    <div class="flex gap-2 items-center bg-gray-50 p-1.5 rounded-lg border border-gray-100">
                        <i class="ph ph-calendar text-gray-400"></i>
                        <input type="date" id="filter-start" class="bg-transparent text-sm outline-none text-gray-600 w-28">
                        <span class="text-gray-400">-</span>
                        <input type="date" id="filter-end" class="bg-transparent text-sm outline-none text-gray-600 w-28">
                        <button onclick="setDateFilter('custom')" class="p-1.5 bg-[#F58220] text-white rounded hover:bg-orange-600 transition"><i class="ph ph-magnifying-glass"></i></button>
                    </div>
                </div>
            </div>`;
        };

        
        // --- STUBS POUR COMPATIBILITÉ (Ancienne logique Multi-Centre) ---
        window.validateSelectionCore = function() {};
        window.openCenterSelectionModal = function() {};
        window.closeCenterSelectionModal = function() {};
        window.applyModalSelection = function() {};
        window.renderModalSearchUI = function() {};
        window.filterCentresForModal = function() {};
        window.toggleSingleSelectionModal = function() {};
        window.renderModalResults = function() {};
        window.renderChips = function() { 
            const container = document.getElementById('chips-container');
            if(container) container.innerHTML = '<span class="text-gray-500 italic">Code centre unique requis.</span>';
        };

        
        // --- LOGIQUE DE GESTION DES SECTIONS (Affichage/Masquage des blocs d'information) ---
        window.resetFormSections = function(isExternal = false) {
            // Champs info du Centre et Dirigeants
            const sectionCentreInfo = document.getElementById('section-centre-info');
            const sectionDirigeants = document.getElementById('section-dirigeants');
            
            // Section Compte Rendu et Bouton Soumettre
            const sectionCR = document.getElementById('section-cr');
            const btnSubmit = document.getElementById('btn-submit');

            // Section Historique (cachée si contact externe)
            const historyPreviewBox = document.getElementById('history-preview-box');

            if (isExternal) {
                // Masquer les infos Centre et Dirigeant
                sectionCentreInfo?.classList.add('hidden');
                sectionDirigeants?.classList.add('hidden');
                historyPreviewBox?.classList.add('hidden');
                
                // Afficher le CR et le bouton
                sectionCR?.classList.remove('hidden');
                btnSubmit?.classList.remove('hidden');
            } else {
                // État initial (tout masqué, en attente de la sélection d'un centre)
                sectionCentreInfo?.classList.add('hidden');
                sectionDirigeants?.classList.add('hidden');
                sectionCR?.classList.add('hidden');
                btnSubmit?.classList.add('hidden');
                historyPreviewBox?.classList.add('hidden');
            }
        };
        

// --- GESTION DU CONTACT EXTERNE (LOGIQUE RÉINTÉGRÉE) ---

        const REGIONAL_MANAGERS = ["AMIRA Illiesse", "AUFFRAY Alexandre", "BECCAVIN Arnaud", "BOULANGER Nicolas", "BUSSAT Virginie", "CARRET Simon", "CHARTON Eric", "DELON Frédéric", "ETHAHMA Youness", "FARJOT Olivier", "GILLE Nicolas", "GOURDEAU David", "GUILLAUD Norbert", "MATHIEU Guillaume", "MONOD Auriane", "MÉNARD Frédéric", "RÉCLA Johan", "TORRES Charlène", "TURGIS Thomas", "ZILA HICHAM"]; // Liste RR mise à jour (Nom Prénom, tri alphabétique)

// --- GESTION DU CONTACT EXTERNE (LOGIQUE RÉINTÉGRÉE ET DYNAMIQUE) ---
window.handleExternalContact = function(value) {
    const isExternal = value !== ''; 
    const codeCentreInput = document.getElementById('code-centre');
    const clientInput = document.getElementById('field_client');
    const contactExterneCode = 'CONTACT_EXTERNE'; 
    const detailsContainer = document.getElementById('external-contact-details');
    
    // 1. Logique de base (Masquer/Afficher sections principales, réinitialiser recherche)
    window.clearSearch(); 
    window.resetFormSections(isExternal); 
    
    const select = document.getElementById('contact-externe-select');
    if (!isExternal && select) select.value = ""; 

    if (isExternal) {
        codeCentreInput.value = contactExterneCode;
        codeCentreInput.disabled = true; 
        clientInput.value = value; // Client name = selected type (e.g., 'Particulier')
        window.currentSelectedCode = null;
    } else {
        codeCentreInput.disabled = false;
        clientInput.value = ""; 
    }
    
    // 2. Logique Dynamique (Afficher les champs spécifiques)
    if (!detailsContainer) return;
    detailsContainer.innerHTML = ''; // Effacer le contenu précédent

    let htmlContent = '';

    switch(value) {
        case 'Responsable Régional':
            const rrOptions = REGIONAL_MANAGERS.sort((a, b) => a.localeCompare(b, 'fr')).map(name => 
                `<option value="${name}">${name}</option>`
            ).join('');
            
            htmlContent = `
                <div class="mt-4">
                    <label class="section-title">Sélectionner le Responsable Régional</label>
                    <div class="relative">
                        <select form="callForm" name="contact_rr_name" id="contact-rr-select" class="w-full p-3 bg-white border border-gray-200 rounded-lg appearance-none focus:border-orange-500 outline-none font-bold text-gray-700">
                            <option value="">-- Sélectionner --</option>
                            ${rrOptions}
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            `;
            break;
        case 'Particulier':
            htmlContent = `
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="section-title">Nom du Particulier</label>
                        <input type="text" form="callForm" name="contact_particulier_name" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="Nom et Prénom">
                    </div>
                    <div>
                        <label class="section-title">Téléphone (facultatif)</label>
                        <input type="tel" form="callForm" name="contact_particulier_phone" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="0x xx xx xx xx">
                    </div>
                </div>
            `;
            break;
        case 'Prestataire':
            htmlContent = `
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="section-title">Nom du Prestataire / Partenaire</label>
                        <input type="text" form="callForm" name="contact_prestataire_name" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="Nom de l'entreprise ou contact">
                    </div>
                    <div>
                        <label class="section-title">Téléphone (facultatif)</label>
                        <input type="tel" form="callForm" name="contact_prestataire_phone" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="0x xx xx xx xx">
                    </div>
                </div>
            `;
            break;
        case 'Démarchage':
            htmlContent = `
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="section-title">Nom Société / Contact</label>
                        <input type="text" form="callForm" name="contact_demarchage_name" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="Nom de l'entreprise ou contact">
                    </div>
                    <div>
                        <label class="section-title">Téléphone à Recontacter (facultatif)</label>
                        <input type="tel" form="callForm" name="contact_demarchage_phone" class="w-full p-3 rounded-lg border bg-white border-gray-200 focus:border-orange-500 outline-none" placeholder="0x xx xx xx xx">
                    </div>
                </div>
            `;
            break;
        case 'Autre':
            htmlContent = `
                <div class="mt-4">
                    <label class="section-title">Information Complémentaire</label>
                    <textarea form="callForm" name="contact_autre_info" rows="2" class="w-full p-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none transition-all resize-none" placeholder="Détaillez la nature de l'appel (nom, organisme, sujet...)"></textarea>
                </div>
            `;
            break;
    }

    detailsContainer.innerHTML = htmlContent;
};


// --- GESTION DE LA DIRECTION D'APPEL ---
window.setCallDirection = function(direction) {
    window.callDirection = direction;
    const btnEntrant = document.getElementById('btn-entrant');
    const btnSortant = document.getElementById('btn-sortant');

    if (btnEntrant && btnSortant) {
        if (direction === 'Entrant') {
            btnEntrant.classList.remove('border-gray-200', 'text-gray-500');
            btnEntrant.classList.add('border-orange-500', 'text-orange-500');
            btnSortant.classList.remove('border-orange-500', 'text-orange-500');
            btnSortant.classList.add('border-gray-200', 'text-gray-500');
        } else if (direction === 'Sortant') {
            btnSortant.classList.remove('border-gray-200', 'text-gray-500');
            btnSortant.classList.add('border-orange-500', 'text-orange-500');
            btnEntrant.classList.remove('border-orange-500', 'text-orange-500');
            btnEntrant.classList.add('border-gray-200', 'text-gray-500');
        }
    }
};

// Fonction de réinitialisation pour la navigation
window.resetCallDirection = function() {
    // Met par défaut sur 'Entrant' (pré-sélection)
    window.callDirection = 'Entrant'; 
    const btnEntrant = document.getElementById('btn-entrant');
    const btnSortant = document.getElementById('btn-sortant');
    
    if (btnEntrant) {
        btnEntrant.classList.remove('border-gray-200', 'text-gray-500');
        btnEntrant.classList.add('border-orange-500', 'text-orange-500');
    }
    if (btnSortant) {
        btnSortant.classList.remove('border-orange-500', 'text-orange-500');
        btnSortant.classList.add('border-gray-200', 'text-gray-500');
    }
}
        
        // --- FIX: Fonction clearSearch ajoutée par script ---
        window.clearSearch = function(event) {
            if(event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Vider le champ visuel
            const input = document.getElementById('code-centre');
            if(input) {
                input.value = "";
                input.focus(); // Remettre le focus pour retaper direct
            }

            // Masquer la boite de suggestions
            const box = document.getElementById('suggestions-box');
            if(box) box.classList.add('hidden');
            
            // Réinitialiser le code sélectionné (variable mono-centre)
            window.currentSelectedCode = null;

            // Appel de la fonction de nettoyage existante (si elle existe)
            if(typeof window.resetForm === 'function') {
                window.resetForm();
            }
        };
        // ----------------------------------------------------
    
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-sidebar');
            if(menu) menu.classList.toggle('hidden');
        }
        
        // --- NAVIGATION ---
        function navigate(view) {
            const container = document.getElementById('app-content');
            ['entry', 'dashboard', 'history', 'followup', 'documentation'].forEach(id => {
                const btn = document.getElementById('btn-' + id);
                if (btn) {
                     if (id === view) btn.className = "w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl bg-[#fef8f3] text-[#F58220] transition-colors";
                     else btn.className = "w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors";
                }
            });

            if(view === 'entry') { 
                container.innerHTML = renderEntry(); 
                // IMPORTANT : Vider les sections au passage à la vue Saisie
                window.resetFormSections(false);
                if(window.preloadCentresData) window.preloadCentresData();
                 
                // *** CORRECTION (Bug ListeVide) ***
                if(window.populateAppSelect && typeof window.populateAppSelect === 'function') {
                    window.populateAppSelect();
                }
                if(typeof window.resetCallDirection === 'function') { 
                    window.resetCallDirection(); 
                }
            } else if(view === 'dashboard') {
                container.innerHTML = renderDashboard();
                initDashboardCharts();
            } else if(view === 'history') {
                container.innerHTML = renderHistory();
            } else if(view === 'followup') {
                container.innerHTML = renderFollowUp();
            } else if(view === 'documentation') { container.innerHTML = renderDocumentation(); }
        }
    
        // --- LOGIQUE MÉTIER ---
        async function checkCentre(code) {
            const cleanCode = (code || document.getElementById('code-centre').value).trim().toUpperCase().split('.')[0];
            const fields = ['reseau', 'client', 'adresse', 'cp', 'ville', 'tel', 'email', 'dirigeant', 'exploitant', 'rr', 'auditeur'];
            
            // Reset des champs avant recherche
            fields.forEach(f => {
                const el = document.getElementById('field_' + f);
                if(el) el.value = "";
            });
            
            // Pas de recherche si moins de 3 caractères
            if (cleanCode.length < 3) return;

            let data = null;

            // 1. Recherche Locale (Backup immédiat)
            if(CENTRES_DB[cleanCode]) {
                data = CENTRES_DB[cleanCode];
            }
            
            // 2. Recherche Firestore (Prioritaire si connecté)
            if(typeof doc === 'function' && typeof getDoc === 'function' && currentUser) {
                try {
                    const appIdRef = typeof appId !== 'undefined' ? appId : 'centre-appels';
                    const docRef = doc(db, 'artifacts', appIdRef, 'public', 'data', 'centres', cleanCode);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        data = docSnap.data();
                        console.log("Données trouvées dans Firestore pour", cleanCode);
                    }
                } catch (e) {
                    console.log("Erreur/Offline Firestore search:", e);
                }
            }

            // Remplissage du formulaire
            if(data) {
                fields.forEach(f => {
                    const el = document.getElementById('field_' + f);
                    if(el) {
                        const key = f === 'client' ? 'nom' : f;
                        if(data[key]) el.value = data[key];
                    }
                });
                
                // Appel auto des infos dirigeant
                if(data.dirigeant) loadDirigeantInfo(data.dirigeant);
                else document.getElementById('dirigeant-info-box')?.classList.add('hidden');
            }
        }
        
        function exportCSV() {
            if (!calls || calls.length === 0) { alert("Aucune donnée à exporter."); return; }
            const headers = ["Date", "Collaborateur SGS", "Code Centre", "Nom Client", "Catégorie", "Sous-catégorie", "Statut", "Compte Rendu"];
            const csvRows = [headers.join(";")];
            calls.forEach(c => {
                const clean = (text) => (text || "").toString().replace(/;/g, ",").replace(/[\r\n]+/gm, " ");
                const row = [c.dateCall, clean(c.agentEmail), c.code, clean(c.client), clean(c.cat || c.category), clean(c.sub), clean(c.status || c.statut), clean(c.cr)];
                csvRows.push(row.join(";"));
            });
            const blob = new Blob(["\uFEFF" + csvRows.join("\\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "export_calltrack_collab.csv";
            link.click();
        }

        // --- VUES (Templates) ---
    
    function toggleMobileMenu() {
            const menu = document.getElementById('mobile-sidebar');
            if(menu) menu.classList.toggle('hidden');
        }
        document.getElementById('mobile-menu-trigger')?.addEventListener('click', toggleMobileMenu);

        // --- NAVIGATION ---
        

        // --- LOGIQUE MÉTIER ---
        async function checkCentre(code) {
            const cleanCode = (code || document.getElementById('code-centre').value).trim().toUpperCase().split('.')[0];
            const fields = ['reseau', 'client', 'adresse', 'cp', 'ville', 'tel', 'email', 'dirigeant', 'exploitant', 'rr', 'auditeur'];
            
            // Reset des champs avant recherche
            fields.forEach(f => {
                const el = document.getElementById('field_' + f);
                if(el) el.value = "";
            });
            
            // Pas de recherche si moins de 3 caractères
            if (cleanCode.length < 3) return;

            let data = null;

            // 1. Recherche Locale (Backup immédiat)
            if(CENTRES_DB[cleanCode]) {
                data = CENTRES_DB[cleanCode];
            }
            
            // 2. Recherche Firestore (Prioritaire si connecté)
            if(typeof doc === 'function' && typeof getDoc === 'function' && currentUser) {
                try {
                    const appIdRef = typeof appId !== 'undefined' ? appId : 'centre-appels';
                    const docRef = doc(db, 'artifacts', appIdRef, 'public', 'data', 'centres', cleanCode);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        data = docSnap.data();
                        console.log("Données trouvées dans Firestore pour", cleanCode);
                    }
                } catch (e) {
                    console.log("Erreur/Offline Firestore search:", e);
                }
            }

            // Remplissage du formulaire
            if(data) {
                fields.forEach(f => {
                    const el = document.getElementById('field_' + f);
                    if(el) {
                        const key = f === 'client' ? 'nom' : f;
                        if(data[key]) el.value = data[key];
                    }
                });
                
                // Appel auto des infos dirigeant
                if(data.dirigeant) loadDirigeantInfo(data.dirigeant);
                else document.getElementById('dirigeant-info-box')?.classList.add('hidden');
            }
        }

        function exportCSV() {
            if (!calls || calls.length === 0) { alert("Aucune donnée à exporter."); return; }
            const headers = ["Date", "Collaborateur SGS", "Code Centre", "Nom Client", "Catégorie", "Sous-catégorie", "Statut", "Compte Rendu"];
            const csvRows = [headers.join(";")];
            calls.forEach(c => {
                const clean = (text) => (text || "").toString().replace(/;/g, ",").replace(/[\r\n]+/gm, " ");
                const row = [c.dateCall, clean(c.agentEmail), c.code, clean(c.client), clean(c.cat || c.category), clean(c.sub), clean(c.status || c.statut), clean(c.cr)];
                csvRows.push(row.join(";"));
            });
            const blob = new Blob(["\uFEFF" + csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "export_calltrack_collab.csv";
            link.click();
        }

        // --- VUES (Templates) ---

        // --- VUE CENTRES (CORRIGÉE MONO-SITE) ---

    
    function renderEntry() {
        return `
        <div id="view-entry" class="fade-in max-w-6xl mx-auto pb-20">
            <h2 class="text-2xl font-bold text-[#F58220] mb-6 flex items-center gap-2">
                <i class="ph ph-phone-outgoing"></i> Nouvel Appel
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                
                

<div class="md:col-span-6 bg-white p-6 rounded-2xl shadow-sm border border-orange-100 flex flex-col justify-between">
    <div>
        <label class="block text-xs font-bold text-orange-400 uppercase mb-2">1. RECHERCHE CODE/NOM/DIRIGEANT</label>
        <div class="relative w-full">
            
            <div class="w-full flex items-center py-2 px-3 bg-orange-50/50 border-2 border-orange-100 rounded-xl focus-within:border-[#F58220] focus-within:bg-white transition-all cursor-text min-h-[50px] space-x-2">
                
                <input type="text" id="code-centre" 
                    class="flex-1 bg-transparent outline-none font-bold text-lg text-gray-700 placeholder-orange-300 min-w-[50%]"
                    placeholder="Code, Nom, Ville ou Dirigeant..." 
                    autocomplete="off"
                    oninput="filterCentres(this.value)"
                    onfocus="onSearchFocus(this)">
                </div>
            
            <div id="suggestions-box" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 max-h-60 overflow-y-auto z-50 divide-y divide-gray-50" style="z-index: 100;"></div>

            <div id="suggestions-box-ac" class="hidden"></div>
        </div>
    </div>
    <p class="text-xs text-gray-400 mt-3"><i class="ph ph-info"></i> Sélectionnez un centre pour charger automatiquement la fiche.</p>
</div>


                
<div class="md:col-span-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col justify-between relative overflow-hidden">
    <div class="absolute top-0 right-0 w-16 h-16 bg-gray-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
    <div class="relative z-10">
        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">2. CONTACT EXTERNE</label>
        <div class="relative">
            
            <select id="contact-externe-select" onchange="handleExternalContact(this.value)" class="w-full pl-4 pr-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-gray-400 outline-none font-bold text-gray-700 appearance-none cursor-pointer hover:bg-white transition-colors">
                <option value="">-- Sélectionner --</option>
                <option value="Responsable Régional">Responsable Régional (RR)</option>
                <option value="Particulier">Particulier</option>
                <option value="Prestataire">Prestataire</option>
                <option value="Démarchage">Démarchage</option>
                <option value="Autre">Autre</option>
            </select>
            <i class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
        </div>
        <div id="external-contact-details">
            </div>
    </div>
    <p class="text-xs text-gray-400 mt-3"><i class="ph ph-eye-slash"></i> Masque les infos centre, affiche uniquement le CR.</p>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                <div class="md:col-span-12">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-3">3. DIRECTION DE L'APPEL</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button type="button" id="btn-entrant" onclick="setCallDirection('Entrant')" class="p-4 rounded-xl border-2 border-orange-500 text-orange-500 font-bold flex flex-col items-center justify-center gap-1 transition-colors hover:border-orange-300 hover:text-orange-500 h-24">
                                <i class="ph ph-phone-incoming text-3xl"></i>
                                <span class="text-sm">Appel Entrant</span>
                            </button>
                            <button type="button" id="btn-sortant" onclick="setCallDirection('Sortant')" class="p-4 rounded-xl border-2 border-gray-200 text-gray-500 font-bold flex flex-col items-center justify-center gap-1 transition-colors hover:border-orange-300 hover:text-orange-500 h-24">
                                <i class="ph ph-phone-outgoing text-3xl"></i>
                                <span class="text-sm">Appel Sortant</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-3"><i class="ph ph-warning-circle"></i> Cette sélection est obligatoire pour l'enregistrement.</p>
                    </div>
                </div>
            </div>
            
            <div id="history-preview-box" class="hidden mb-6 bg-white rounded-2xl shadow-sm border border-purple-100 relative overflow-hidden fade-in">
                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                <div class="p-4 border-b border-purple-50 bg-purple-50/30 flex justify-between items-center">
                    <h3 class="text-purple-700 font-bold text-sm uppercase flex items-center gap-2">
                        <i class="ph ph-clock-counter-clockwise text-xl"></i> Derniers Échanges (5 max)
                    </h3>
                    <span class="text-xs text-purple-400 font-mono" id="hist-count-badge">0 trouvés</span>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-50/50">
                            <tr>
                                <th class="p-3 font-medium">Date</th>
                                <th class="p-3 font-medium">Collaborateur SGS</th>
                                <th class="p-3 font-medium">Statut</th>
                                <th class="p-3 font-medium w-1/2">Note Rapide</th>
                            </tr>
                        </thead>
                        <tbody id="history-preview-rows" class="divide-y divide-gray-50">
                            </tbody>
                    </table>
                </div>
            </div>

            <form id="callForm" class="space-y-6">
    
                
                <div id="section-centre-info" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 left-0 w-1 h-full bg-[#F58220]"></div>
                    <h3 class="text-[#F58220] font-bold text-sm uppercase mb-4 flex items-center gap-2">
                        <i class="ph ph-storefront text-xl"></i> Informations du Centre
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="section-title">Réseau</label><input id="field_reseau" readonly class="w-full p-3 rounded-lg border bg-gray-50 font-bold text-gray-700"></div>
                        <div><label class="section-title">Nom Commercial</label><input id="field_client" readonly class="w-full p-3 rounded-lg border bg-gray-50 font-bold text-gray-700"></div>
                        <div class="md:col-span-2"><label class="section-title">Adresse</label><input id="field_adresse" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-600"></div>
                        <div class="flex gap-4 md:col-span-2">
                            <div class="w-32"><label class="section-title">CP</label><input id="field_cp" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-600"></div>
                            <div class="flex-1"><label class="section-title">Ville</label><input id="field_ville" readonly class="w-full p-3 rounded-lg border bg-gray-50 font-bold text-gray-700"></div>
                        </div>
                        <div><label class="section-title">Téléphone</label><input id="field_telephone" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-800 font-mono"></div>
                        
                        <div class="relative">
                            <label class="section-title">Email</label>
                            <input id="field_email" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-blue-600 pr-10" placeholder="Email">
                            <a href="#" onclick="window.open('mailto:' + document.getElementById('field_email').value, '_blank')" class="absolute right-0 bottom-0 top-[2.5rem] -translate-y-1/2 mr-1 p-1 text-blue-500 hover:text-blue-700 disabled:opacity-50 disabled:pointer-events-none transition-colors" title="Envoyer un email au centre">
                                <i class="ph ph-envelope-simple text-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="section-dirigeants" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <h3 class="text-blue-600 font-bold text-sm uppercase mb-4 flex items-center gap-2">
                        <i class="ph ph-users-three text-xl"></i> Dirigeants & Responsables
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <label class="text-xs font-bold text-blue-400 uppercase mb-1 block">Dirigeant</label>
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold"><i class="ph ph-user-crown text-xl"></i></div>
                                <input id="field_dirigeant" readonly class="flex-1 p-3 bg-white border-0 rounded-xl shadow-sm font-bold text-blue-900 placeholder-blue-200" placeholder="Nom du dirigeant">
                            </div>
                            <div id="dirigeant-info-box" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2 hidden border-t border-blue-100 pt-3">
                                <input id="dir_mobile" readonly class="w-full p-3 text-sm bg-white rounded-lg border border-blue-100 text-blue-800 font-mono" placeholder="Mobile">
                                <div class="relative flex items-center">
                                    <input id="dir_email" readonly class="flex-1 p-3 text-sm bg-white rounded-lg border border-blue-100 text-blue-800 pr-10" placeholder="Email">
                                    <a href="#" onclick="window.open('mailto:' + document.getElementById('dir_email').value, '_blank')" class="absolute right-0 top-1/2 -translate-y-1/2 mr-1 p-1 text-blue-500 hover:text-blue-700 disabled:opacity-50 disabled:pointer-events-none transition-colors" title="Envoyer un email au dirigeant">
                                        <i class="ph ph-envelope-simple text-lg"></i>
                                    </a>
                                </div>
                                <input id="dir_adresse" readonly class="md:col-span-2 w-full p-3 text-sm bg-white rounded-lg border border-blue-100 text-blue-800" placeholder="Adresse">
                            </div>
                        </div>
                        <div><label class="section-title">Exploitant</label><input id="field_exploitant" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-700"></div>
                        <div><label class="section-title">Resp. Régional (RR)</label><input id="field_rr" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-700"></div>
                        <div class="md:col-span-2"><label class="section-title">Auditeur</label><input id="field_auditeur" readonly class="w-full p-3 rounded-lg border bg-gray-50 text-gray-700"></div>
                    </div>
                </div>

                <div id="section-cr" class="hidden bg-gray-50 p-6 rounded-2xl border border-gray-200">
                    
                    <h3 class="text-gray-500 font-bold text-sm uppercase mb-4 flex items-center gap-2">
                        <i class="ph ph-notepad"></i> Qualification & Compte-Rendu
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Application Concernée</label>
                            <div class="relative">
                                <select name="app_concern" id="select-app" onchange="updateCategoryOptions()" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg appearance-none focus:border-orange-500 outline-none text-sm font-bold text-gray-700">
                                    <option value="">-- Sélectionner --</option>
                                </select>
                                <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Catégorie</label>
                            <div class="relative">
                                <select name="cat" id="select-cat" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg appearance-none focus:border-orange-500 outline-none text-sm font-bold text-gray-700">
                                    <option value="">-- D'abord choisir l'app --</option>
                                </select>
                                <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
    
                    
                    <div class="mb-4">
                        <label class="section-title">Statut de l'appel</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="status" value="Clôturé" class="peer hidden" checked>
                                <div class="p-3 text-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-green-50 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500 transition-all font-bold text-sm flex items-center justify-center gap-2">
                                    <i class="ph ph-check"></i> Clôturé
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status" value="À rappeler" class="peer hidden">
                                <div class="p-3 text-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-yellow-50 peer-checked:bg-yellow-400 peer-checked:text-white peer-checked:border-yellow-400 peer-checked:shadow-md transition-all font-bold text-sm flex items-center justify-center gap-2">
                                    <i class="ph ph-bell-ringing"></i> À Rappeler
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status" value="En cours" class="peer hidden">
                                <div class="p-3 text-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-blue-50 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all font-bold text-sm flex items-center justify-center gap-2">
                                    <i class="ph ph-hourglass"></i> En cours
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status" value="À traiter" class="peer hidden">
                                <div class="p-3 text-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-orange-50 peer-checked:bg-orange-400 peer-checked:text-white peer-checked:border-orange-400 transition-all font-bold text-sm flex items-center justify-center gap-2">
                                    <i class="ph ph-wrench"></i> À traiter
                                </div>
                            </label>
                        </div>
                    </div>


                    <div>
                        <label class="section-title">Commentaire</label>
                        <textarea name="cr" id="commentaire" rows="3" class="w-full p-4 rounded-xl border-gray-200 border focus:border-[#F58220] focus:ring-1 focus:ring-orange-200 outline-none transition-all resize-none" placeholder="Détails de l'échange..."></textarea>
                    </div>
                </div>

                <button id="btn-submit" type="submit" class="hidden w-full bg-[#F58220] text-white py-4 rounded-xl font-bold text-lg hover:bg-[#d9731c] transition-transform active:scale-[0.99] shadow-xl shadow-orange-100 flex justify-center items-center gap-2">
                    <i class="ph ph-floppy-disk"></i> Enregistrer l'Appel
                </button>
            </form>
        </div>
        `;
    }

        
        function renderDashboard() {
            const filteredCalls = window.getFilteredCalls();
            const totalCalls = filteredCalls.length;
            
            // Calcul des stats Statut (KPIs)
            const statusStats = { "Clôturé": 0, "En cours": 0, "À traiter": 0, "À rappeler": 0 };
            filteredCalls.forEach(c => { const s = c.status || c.statut; if(statusStats[s] !== undefined) statusStats[s]++; });

            // Calcul Top RR (Pour le tableau du bas)
            const rrCounts = {};
            filteredCalls.forEach(c => {
                if (c.code === 'CONTACT_EXTERNE' && c.client === 'Responsable Régional') {
                    let name = c.contact_rr_name || c.rr || 'Inconnu';
                    rrCounts[name] = (rrCounts[name] || 0) + 1;
                }
            });
            // Top 10 pour la vue large
            const sortedRRs = Object.entries(rrCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-[#76787B]">Tableau de Bord Décisionnel</h2>
                        <span class="text-sm font-bold text-orange-500 bg-orange-50 px-3 py-1 rounded-full">${totalCalls} Appels sur la période</span>
                    </div>
                    
                    ${window.renderFilterBar()}

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center">
                            <div><p class="text-xs text-gray-400 uppercase font-bold">Clôturés</p><p class="text-2xl font-bold text-gray-800">${statusStats['Clôturé']}</p></div>
                            <i class="ph ph-check-circle text-green-200 text-3xl"></i>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                            <div><p class="text-xs text-gray-400 uppercase font-bold">En cours</p><p class="text-2xl font-bold text-gray-800">${statusStats['En cours']}</p></div>
                            <i class="ph ph-hourglass text-blue-200 text-3xl"></i>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-400 flex justify-between items-center">
                            <div><p class="text-xs text-gray-400 uppercase font-bold">À Traiter</p><p class="text-2xl font-bold text-gray-800">${statusStats['À traiter']}</p></div>
                            <i class="ph ph-wrench text-orange-200 text-3xl"></i>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400 flex justify-between items-center">
                            <div><p class="text-xs text-gray-400 uppercase font-bold">À Rappeler</p><p class="text-2xl font-bold text-gray-800">${statusStats['À rappeler']}</p></div>
                            <i class="ph ph-phone-outgoing text-red-200 text-3xl"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="ph ph-chart-donut text-[#F58220]"></i> Répartition Globale</h3>
                            <div class="h-64 relative">
                                <canvas id="chartSunburst"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2 text-center">App (Int.) / Cat (Ext.)</p>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                            <h3 class="font-bold text-gray-700 mb-2 text-center w-full"><i class="ph ph-arrows-left-right text-[#F58220]"></i> Direction des Appels</h3>
                            <div class="h-64 w-full"><canvas id="chartDirection"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="ph ph-grid-four text-[#F58220]"></i> Matrice d'Incidents (App x Catégorie)</h3>
                            <span class="text-[10px] bg-orange-50 text-orange-600 px-3 py-1 rounded-full border border-orange-100 font-bold">Vue Détail</span>
                        </div>
                        <div class="overflow-x-auto border border-gray-50 rounded-lg">
                            <div id="matrix-container" class="min-w-full">
                                <div class="p-4 text-center text-gray-400 italic">Chargement des données...</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="ph ph-medal text-[#F58220]"></i> Top Sollicitations Responsables Régionaux</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                                    <tr><th class="p-3 rounded-l-lg">Nom du RR</th><th class="p-3 text-right rounded-r-lg">Volume d'appels</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${sortedRRs.map(([rr, count]) => `
                                        <tr class="hover:bg-orange-50/50 transition">
                                            <td class="p-3 font-medium text-gray-700">${window.escapeHTML(rr) === 'undefined' ? 'Non assigné' : rr}</td>
                                            <td class="p-3 text-right font-bold text-[#F58220]">${count}</td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="2" class="p-4 text-center text-gray-400 italic">Pas assez de données</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }

        window.initDashboardCharts = function() {
            const filteredCalls = window.getFilteredCalls();
            
            // --- A. DONNÉES POUR SUNBURST & MATRICE ---
            const dataTree = {}; 
            const matrixData = {};
            const appTotals = {};
            const catTotals = {};
            const allCats = new Set();

            filteredCalls.forEach(c => { 
                const app = c.app_concern || 'Autre';
                const cat = c.cat || c.category || 'Non classé'; // Compatibilité
                
                // Arbre pour Sunburst
                if(!dataTree[app]) dataTree[app] = { total: 0, cats: {} };
                dataTree[app].total++;
                if(!dataTree[app].cats[cat]) dataTree[app].cats[cat] = 0;
                dataTree[app].cats[cat]++;

                // Données pour Matrice
                if(!matrixData[app]) matrixData[app] = {};
                if(!matrixData[app][cat]) matrixData[app][cat] = 0;
                matrixData[app][cat]++;
                
                appTotals[app] = (appTotals[app] || 0) + 1;
                catTotals[cat] = (catTotals[cat] || 0) + 1;
                allCats.add(cat);
            });

            // --- B. RENDU GRAPHIQUE SUNBURST (Chart.js) ---
            
            // 1. Préparation des données aplaties et alignées
            let sbLabels = [];
            let sbDataInner = []; // Apps
            let sbDataOuter = []; // Cats
            let sbColorsInner = [];
            let sbColorsOuter = [];

            // Palette de couleurs de base
            const baseColors = ['#F58220', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#ec4899'];
            
            // Tri des apps par volume pour le Sunburst
            const sortedAppsForChart = Object.keys(dataTree).sort((a,b) => dataTree[b].total - dataTree[a].total);

            sortedAppsForChart.forEach((app, index) => {
                // Niveau 1 : L'App
                sbLabels.push(app);
                sbDataInner.push(dataTree[app].total);
                
                const color = baseColors[index % baseColors.length];
                sbColorsInner.push(color);

                // Niveau 2 : Les Catégories de cette App
                // On trie aussi les sous-catégories par volume
                const sortedSubCats = Object.keys(dataTree[app].cats).sort((a,b) => dataTree[app].cats[b] - dataTree[app].cats[a]);
                
                sortedSubCats.forEach((cat, cIndex) => {
                    sbDataOuter.push(dataTree[app].cats[cat]);
                    // Couleur dérivée (même teinte)
                    sbColorsOuter.push(color); 
                });
            });

            const ctx = document.getElementById('chartSunburst');
            if(ctx) {
                const existingChart = Chart.getChart("chartSunburst");
                if (existingChart) existingChart.destroy();

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedAppsForChart,
                        datasets: [{
                            label: 'Appels',
                            data: sbDataInner,
                            backgroundColor: sbColorsInner,
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '65%', 
                        plugins: { 
                            legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true, font: { size: 11 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.raw || 0;
                                        let total = context.chart._metasets[context.datasetIndex].total;
                                        let percentage = Math.round((value / total) * 100) + '%';
                                        return label + ': ' + value + ' (' + percentage + ')';
                                    }
                                }
                            }
                        } 
                    }
                });
            }

            // --- C. RENDU MATRICE (Heatmap HTML) ---
            
            const sortedApps = Object.keys(matrixData).sort((a,b) => appTotals[b] - appTotals[a]);
            const sortedCats = Array.from(allCats).sort((a,b) => catTotals[b] - catTotals[a]).slice(0, 8);

            let html = '<table class="w-full text-sm text-left border-collapse">';
            html += '<thead class="sticky top-0 z-10 shadow-sm"><tr class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-200">';
            html += '<th class="p-3 font-bold bg-gray-100/90 backdrop-blur border-r border-gray-200 rounded-tl-lg text-[#F58220]">Application</th>';
            sortedCats.forEach(cat => {
                const shortCat = cat.length > 15 ? cat.substring(0, 15) + '...' : cat;
                html += `<th class="p-2 font-bold bg-gray-50/90 backdrop-blur text-center w-24 border-r border-gray-100" title="${cat}">${shortCat}</th>`;
            });
            html += '</tr></thead>';

            html += '<tbody class="divide-y divide-gray-50">';
            sortedApps.forEach(app => {
                html += `<tr class="hover:bg-orange-50/30 transition group">`;
                html += `<td class="p-3 font-bold text-gray-700 border-r border-gray-100 bg-white group-hover:bg-orange-50/30 whitespace-nowrap">${app}</td>`;
                
                sortedCats.forEach(cat => {
                    const count = matrixData[app][cat] || 0;
                    const intensity = Math.min(count / 10, 1); 
                    let bgStyle = '';
                    let textClass = 'text-gray-300';
                    let content = '-';

                    if (count > 0) {
                        bgStyle = `background-color: rgba(245, 130, 32, ${0.1 + (intensity * 0.9)})`; 
                        textClass = intensity > 0.5 ? 'text-white font-bold' : 'text-orange-900 font-bold';
                        content = count;
                    }
                    html += `<td class="p-2 text-center ${textClass} border-r border-dotted border-gray-100 transition-transform hover:scale-105 cursor-default" style="${bgStyle}" title="${app} : ${cat} (${count})">${content}</td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';

            const container = document.getElementById('matrix-container');
            if(container) container.innerHTML = html;
            
            // --- D. GRAPHIQUE DIRECTION (Reload) ---
             let entrant = 0, sortant = 0;
            filteredCalls.forEach(c => {
                if(c.direction === 'Entrant') entrant++;
                else if(c.direction === 'Sortant') sortant++;
            });

            const ctxDir = document.getElementById('chartDirection');
            if(ctxDir) {
                 const existingChartDir = Chart.getChart("chartDirection");
                 if (existingChartDir) existingChartDir.destroy();
                 
                 new Chart(ctxDir, {
                    type: 'pie',
                    data: {
                        labels: ['Entrant', 'Sortant'],
                        datasets: [{
                            data: [entrant, sortant],
                            backgroundColor: ['#10b981', '#3b82f6'], 
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }
        };
    

        function renderFollowUp() {
            // Filtrage des appels à traiter
            const todoCalls = calls.filter(c => {
                const s = c.status || c.statut;
                return ['En cours', 'À traiter', 'À rappeler'].includes(s);
            });

            // Tri : Les plus anciens d'abord ? Ou les plus récents ?
            const rows = todoCalls.sort((a,b) => (a.dateCall < b.dateCall ? 1 : -1)).map(c => `
                <tr class="border-b last:border-0 hover:bg-orange-50/40 transition group">
                    <td class="p-3 font-mono text-xs text-gray-500">${window.escapeHTML(c.dateCall)}</td>
                    <td class="p-3 font-bold text-gray-700 text-sm">${window.escapeHTML(c.code)}</td>
                    <td class="p-3"><div class="font-bold text-[#76787B] text-sm truncate w-32 md:w-auto">${window.escapeHTML(c.client)}</div></td>
                    <td class="p-3 text-xs hidden md:table-cell text-gray-500">${window.escapeHTML(c.agentEmail) || 'Inconnu'}</td>
                    <td class="p-3 text-sm hidden md:table-cell"><span class="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs">${window.escapeHTML(c.cat || c.category)}</span></td>
                    <td class="p-3">${window.getStatusBadge(c.status || c.statut)}</td>
                    <td class="p-3 w-1/3">
                        <p class="text-xs text-gray-600 line-clamp-2 leading-relaxed max-w-md" title="${window.escapeHTML(c.cr) || ''}">${window.escapeHTML(c.cr) || '<span class="italic text-gray-300">Aucun commentaire</span>'}</p>
                    </td>
                    
                </tr>
            `).join('');

            return `
                <div id="view-history" class="fade-in">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-orange-600 flex items-center gap-2"><i class="ph ph-list-checks"></i> Suivi des Actions</h2>
                            <p class="text-sm text-gray-400">Tickets nécessitant une intervention (En cours, À traiter, À rappeler)</p>
                        </div>
                        <div class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg font-bold text-sm border border-orange-200">
                            ${todoCalls.length} dossiers en attente
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-orange-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead class="bg-orange-50 text-xs font-bold text-orange-400 uppercase border-b border-orange-100">
                                    <tr>
                                        <th class="p-3">Date</th>
                                        <th class="p-3">Code</th>
                                        <th class="p-3">Client</th>
                                        <th class="p-3 hidden md:table-cell">Collaborateur SGS</th>
                                        <th class="p-3 hidden md:table-cell">Catégorie</th>
                                        <th class="p-3">Statut</th>
                                        <th class="p-3 w-1/3">Note</th>
                                        
                                    </tr>
                                </thead>
                                <tbody>${rows || '<tr><td colspan="7" class="p-8 text-center italic text-gray-400">Aucune action en attente. Bon travail ! <i class="ph ph-smiley"></i></td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }
    

        
    // --- GESTION AVANCÉE HISTORIQUE (TRIS & FILTRES) ---
    let histState = {
        sortCol: 'timestamp',
        sortAsc: false,
        filterText: '',
        filterStatus: '',
        currentPage: 1,      // Page par défaut
        itemsPerPage: 10     // Nombre de lignes par page
    };

    // Fonction principale qui calcule et affiche les lignes
    
    // --- FONCTION DE RAFRAICHISSEMENT AVEC PAGINATION ---
    window.refreshHistoryTable = function() {
        const tbody = document.getElementById('history-table-body');
        const countSpan = document.getElementById('history-count');
        const paginationContainer = document.getElementById('pagination-controls'); // Nouveau conteneur
        
        if(!tbody) return;

        // 1. FILTRAGE
        const dateFiltered = window.getFilteredCalls();
        
        let filtered = dateFiltered.filter(c => {
            const searchStr = (histState.filterText || '').toLowerCase();
            const statusFilter = histState.filterStatus;
            
            const code = (c.code || '').toLowerCase();
            const client = (c.client || '').toLowerCase();
            const agent = (c.agentEmail || '').toLowerCase();
            const statut = (c.status || c.statut || '').toString();

            const textMatch = !searchStr || code.includes(searchStr) || client.includes(searchStr) || agent.includes(searchStr);
            const statusMatch = !statusFilter || statut === statusFilter;

            return textMatch && statusMatch;
        });

        // 2. TRI
        filtered.sort((a, b) => {
            let valA, valB;
            if (histState.sortCol === 'timestamp') {
                valA = a.timestamp || 0; valB = b.timestamp || 0;
            } else if (histState.sortCol === 'dateCall') {
                valA = a.dateCall || ''; valB = b.dateCall || '';
            } else if (histState.sortCol === 'statut') {
                valA = (a.status || a.statut || '').toLowerCase(); valB = (b.status || b.statut || '').toLowerCase();
            } else if (histState.sortCol === 'agent') {
                valA = (a.agentEmail || '').toLowerCase(); valB = (b.agentEmail || '').toLowerCase();
            } else {
                valA = (a[histState.sortCol] || '').toLowerCase(); valB = (b[histState.sortCol] || '').toLowerCase();
            }

            if (valA < valB) return histState.sortAsc ? -1 : 1;
            if (valA > valB) return histState.sortAsc ? 1 : -1;
            return 0;
        });

        // --- 3. LOGIQUE PAGINATION ---
        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / histState.itemsPerPage) || 1;

        // Sécurité : Si on est sur la page 5 mais qu'il n'y a plus que 2 pages après filtrage
        if (histState.currentPage > totalPages) histState.currentPage = totalPages;
        if (histState.currentPage < 1) histState.currentPage = 1;

        // Découpage des données pour la page actuelle
        const startIndex = (histState.currentPage - 1) * histState.itemsPerPage;
        const endIndex = startIndex + histState.itemsPerPage;
        const paginatedData = filtered.slice(startIndex, endIndex);

        // --- 4. RENDU HTML (Lignes) ---
        const html = paginatedData.map(c => `
            <tr class="border-b last:border-0 hover:bg-gray-50 transition group">
                <td class="p-3 font-mono text-xs text-gray-500">${window.escapeHTML(c.dateCall)}</td>
                <td class="p-3 font-bold text-gray-700 text-sm">${window.escapeHTML(c.code)}</td>
                <td class="p-3"><div class="font-bold text-[#76787B] text-sm truncate w-32 md:w-auto">${window.escapeHTML(c.client)}</div></td>
                <td class="p-3 text-sm text-gray-600 font-medium">${window.escapeHTML(c.app_concern || "-")}</td>
                <td class="p-3 text-sm"><span class="px-2 py-1 rounded bg-orange-50 text-orange-700 text-xs">${window.escapeHTML(c.cat || c.category)}</span></td>
                <td class="p-3 text-xs text-gray-500">${window.escapeHTML(c.agentEmail) || "Inconnu"}</td>
                <td class="p-3">${window.getStatusBadge(c.status || c.statut)}</td>
                <td class="p-3 w-1/3">
                    <p class="text-xs text-gray-600 line-clamp-2 leading-relaxed max-w-md" title="${window.escapeHTML(c.cr) || ''}">${window.escapeHTML(c.cr) || '<span class="italic text-gray-300">Aucun commentaire</span>'}</p>
                </td>
                
            </tr>
        `).join('');

        tbody.innerHTML = html || '<tr><td colspan="7" class="p-8 text-center italic text-gray-400">Aucun résultat ne correspond à votre recherche.</td></tr>';
        
        // Mise à jour compteur global
        if(countSpan) countSpan.innerText = `${totalItems} appels`;
        
        updateSortIcons();

        // --- 5. RENDU PAGINATION (Boutons) ---
        renderPaginationControls(totalPages, totalItems);
    };

    // Fonction pour générer les boutons de pagination
    window.renderPaginationControls = function(totalPages, totalItems) {
        const start = (histState.currentPage - 1) * histState.itemsPerPage + 1;
        const end = Math.min(histState.currentPage * histState.itemsPerPage, totalItems);
        
        // Génération du HTML des boutons
        const html = `
            <div class="text-xs text-gray-500 font-medium flex items-center">
                <span class="hidden md:inline mr-2">Affichage de <b>${totalItems > 0 ? start : 0}</b> à <b>${end}</b> sur <b>${totalItems}</b></span>
            </div>
            <div class="flex gap-2">
                <button onclick="changePage(-1)" ${histState.currentPage === 1 ? 'disabled' : ''} class="px-3 py-1.5 text-xs font-bold rounded-lg border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-gray-600 transition flex items-center gap-1">
                    <i class="ph ph-caret-left"></i> Préc.
                </button>
                <div class="flex items-center px-2">
                    <span class="text-xs font-bold text-gray-700">Page ${histState.currentPage} / ${totalPages}</span>
                </div>
                <button onclick="changePage(1)" ${histState.currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1.5 text-xs font-bold rounded-lg border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-gray-600 transition flex items-center gap-1">
                    Suiv. <i class="ph ph-caret-right"></i>
                </button>
            </div>
        `;

        // Injection en haut et en bas
        const topEl = document.getElementById('pagination-controls-top');
        const botEl = document.getElementById('pagination-controls-bottom');
        
        if(topEl) topEl.innerHTML = html;
        if(botEl) botEl.innerHTML = html;
    };

    window.changePage = function(delta) {
        histState.currentPage += delta;
        refreshHistoryTable();
    };


    // Actions UI
    window.setHistorySort = function(col) {
        if (histState.sortCol === col) {
            histState.sortAsc = !histState.sortAsc; // Inverse
        } else {
            histState.sortCol = col;
            histState.sortAsc = true; // Reset
        }
        refreshHistoryTable();
    };

    window.setHistoryFilter = function(val) {
        histState.filterText = val; histState.currentPage = 1;
        refreshHistoryTable();
    };

    window.setHistoryStatusFilter = function(val) {
        histState.filterStatus = val; histState.currentPage = 1;
        refreshHistoryTable();
    };

    function updateSortIcons() {
        // Reset toutes les icônes
        document.querySelectorAll('.sort-icon').forEach(i => i.className = 'ph ph-arrows-down-up sort-icon text-gray-300 ml-1');
        
        // Active la bonne
        const activeIcon = document.getElementById('sort-' + histState.sortCol);
        if(activeIcon) {
            activeIcon.className = histState.sortAsc ? 'ph ph-arrow-up sort-icon text-[#F58220] ml-1' : 'ph ph-arrow-down sort-icon text-[#F58220] ml-1';
        }
    }
    

        
        
    function renderDocumentation() {
        return `
        <div id="view-documentation" class="fade-in max-w-5xl mx-auto pb-20 space-y-8">
            
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-[#F58220] mb-2 flex items-center justify-center gap-3">
                    <i class="ph ph-book-open"></i> Guide Utilisateur
                </h2>
                <p class="text-gray-500">Documentation fonctionnelle pour la prise en main de l'application.</p>
            </div>

            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                    Navigation & Vue d'ensemble
                </h3>
                <p class="text-gray-600 mb-6">L'application est divisée en 4 sections principales accessibles via le menu latéral gauche :</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="bg-white p-2 rounded-lg text-[#F58220] shadow-sm"><i class="ph ph-phone-plus text-xl"></i></div>
                        <div>
                            <span class="font-bold text-gray-700 block">Nouvel Appel</span>
                            <span class="text-sm text-gray-500">L'écran principal pour enregistrer un appel (Entrant ou Sortant).</span>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="bg-white p-2 rounded-lg text-[#F58220] shadow-sm"><i class="ph ph-chart-pie-slice text-xl"></i></div>
                        <div>
                            <span class="font-bold text-gray-700 block">Tableau de Bord</span>
                            <span class="text-sm text-gray-500">Outil de pilotage affichant les statistiques et graphiques en temps réel.</span>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="bg-white p-2 rounded-lg text-[#F58220] shadow-sm"><i class="ph ph-clock-counter-clockwise text-xl"></i></div>
                        <div>
                            <span class="font-bold text-gray-700 block">Historique</span>
                            <span class="text-sm text-gray-500">La liste brute de tous les appels passés, avec recherche et filtres.</span>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="bg-white p-2 rounded-lg text-[#F58220] shadow-sm"><i class="ph ph-list-checks text-xl"></i></div>
                        <div>
                            <span class="font-bold text-gray-700 block">Suivi des Actions</span>
                            <span class="text-sm text-gray-500">Votre "To-Do List". Affiche uniquement les appels non résolus.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                    Comment saisir un appel ?
                </h3>
                <div class="space-y-6">
                    <div class="flex gap-4">
                        <div class="flex-none flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center font-bold text-sm">A</div>
                            <div class="h-full w-0.5 bg-gray-100 my-1"></div>
                        </div>
                        <div class="pb-4">
                            <h4 class="font-bold text-gray-800">Identifier l'interlocuteur</h4>
                            <p class="text-sm text-gray-600 mt-1">
                                <span class="font-bold text-gray-700">Option 1 (Centre) :</span> Utilisez la barre de recherche. Tapez un Code (ex: 94002), une Ville ou un Nom. Cliquez sur la suggestion pour pré-remplir la fiche.<br>
                                <span class="font-bold text-gray-700">Option 2 (Externe) :</span> Si ce n'est pas un centre (ex: Particulier, RR...), utilisez le menu déroulant "Contact Externe".
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-none flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center font-bold text-sm">B</div>
                            <div class="h-full w-0.5 bg-gray-100 my-1"></div>
                        </div>
                        <div class="pb-4">
                            <h4 class="font-bold text-gray-800">Définir la Direction</h4>
                            <p class="text-sm text-gray-600 mt-1">Cliquez obligatoirement sur <span class="text-orange-500 font-bold">Appel Entrant</span> (on vous appelle) ou <span class="text-orange-500 font-bold">Appel Sortant</span> (vous appelez).</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-none flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center font-bold text-sm">C</div>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800">Qualifier et Conclure</h4>
                            <p class="text-sm text-gray-600 mt-1 mb-2">Choisissez l'Application concernée, la Catégorie précise, et surtout le <strong>Statut</strong> :</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                                <div class="px-3 py-2 bg-green-50 text-green-700 rounded-lg border border-green-100 flex items-center gap-2">
                                    <i class="ph ph-check-circle text-lg"></i> <strong>Clôturé :</strong> Terminé, rien à faire.
                                </div>
                                <div class="px-3 py-2 bg-blue-50 text-blue-700 rounded-lg border border-blue-100 flex items-center gap-2">
                                    <i class="ph ph-hourglass text-lg"></i> <strong>En cours :</strong> En attente (réponse client...).
                                </div>
                                <div class="px-3 py-2 bg-orange-50 text-orange-700 rounded-lg border border-orange-100 flex items-center gap-2">
                                    <i class="ph ph-wrench text-lg"></i> <strong>À traiter :</strong> Action requise de notre part.
                                </div>
                                <div class="px-3 py-2 bg-yellow-50 text-yellow-700 rounded-lg border border-yellow-100 flex items-center gap-2">
                                    <i class="ph ph-bell-ringing text-lg"></i> <strong>À rappeler :</strong> Rappel planifié.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                    Comprendre les Statistiques
                </h3>
                <p class="text-gray-600 mb-4 text-sm">Le Tableau de Bord permet d'analyser l'activité. Vous pouvez filtrer par <strong>Période</strong> (Jour, Semaine...) ou par <strong>Collaborateur</strong> via la barre supérieure.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-[#F58220] flex items-center gap-2 mb-2"><i class="ph ph-chart-donut"></i> Répartition (Sunburst)</h4>
                        <p class="text-xs text-gray-500 leading-relaxed text-justify">
                            Ce graphique à double niveau montre le volume d'appels.<br>
                            - <strong>Cercle Intérieur :</strong> Les grands domaines (Applications).<br>
                            - <strong>Cercle Extérieur :</strong> Les détails (Catégories).<br>
                            Survolez une zone pour voir le nombre exact d'appels.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-[#F58220] flex items-center gap-2 mb-2"><i class="ph ph-grid-four"></i> Matrice d'Incidents</h4>
                        <p class="text-xs text-gray-500 leading-relaxed text-justify">
                            Ce tableau croisé (Heatmap) permet d'identifier les "sujets chauds".<br>
                            Plus une case est <strong>foncée</strong>, plus il y a eu d'appels sur ce croisement (Application x Problème). Idéal pour détecter une panne générale.
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-orange-50 to-white p-6 rounded-2xl border border-orange-100">
                <h3 class="font-bold text-orange-800 flex items-center gap-2 mb-2"><i class="ph ph-lightbulb"></i> Le saviez-vous ?</h3>
                <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
                    <li>Vous pouvez <strong>exporter</strong> vos données en CSV depuis l'onglet Historique.</li>
                    <li>Cliquez sur un appel dans l'Historique pour <strong>modifier son statut</strong> ou ajouter une note ultérieurement.</li>
                    <li>Le "Suivi des Actions" affiche un badge rouge dans le menu s'il y a des dossiers en attente.</li>
                </ul>
            </div>
        </div>
        `;
    }

        function renderHistory() {
            setTimeout(() => refreshHistoryTable(), 50);
            return `
                <div class="fade-in">
                    ${window.renderFilterBar()}
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#76787B]">Historique Global</h2>
                            <p class="text-sm text-gray-400">Tous les appels de l'équipe</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-3 py-2 bg-white border rounded-lg text-xs font-bold text-gray-500 flex items-center gap-2">
                                <i class="ph ph-database"></i> <span id="history-count">...</span>
                            </span>
                            <button onclick="exportCSV()" class="px-4 py-2 bg-white border rounded-lg text-sm hover:bg-gray-50 text-gray-600 font-medium">
                                <i class="ph ph-download-simple"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
                            <div class="relative flex-1 w-full">
                                <input type="text" oninput="setHistoryFilter(this.value)" class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:border-[#F58220] outline-none text-sm transition-colors" placeholder="Rechercher...">
                            </div>
                            <div class="w-full md:w-48 relative">
                                <select onchange="setHistoryStatusFilter(this.value)" class="w-full pl-3 pr-8 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:border-[#F58220] outline-none text-sm appearance-none cursor-pointer">
                                    <option value="">Tous les statuts</option>
                                    <option value="En cours">En cours</option>
                                    <option value="À traiter">À traiter</option>
                                    <option value="À rappeler">À rappeler</option>
                                    <option value="Clôturé">Clôturé</option>
                                </select>
                                <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div id="pagination-controls-top" class="flex justify-end mb-2"></div>

                        <div class="rounded-xl border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left whitespace-nowrap">
                                    <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b">
                                        <tr>
                                            <th onclick="setHistorySort('timestamp')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Date <i id="sort-timestamp" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort('code')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Code <i id="sort-code" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort('client')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Client <i id="sort-client" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort(\'app_concern\')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Application <i id="sort-app" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort(\'cat\')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Catégorie <i id="sort-cat" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort(\'agent\')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Collaborateur <i id="sort-agent" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th onclick="setHistorySort('statut')" class="p-3 cursor-pointer hover:bg-gray-100 transition select-none">Statut <i id="sort-statut" class="ph ph-arrows-down-up ml-1"></i></th>
                                            <th class="p-3 w-1/3">Note</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body"><tr><td colspan="7" class="p-8 text-center text-gray-400">Chargement...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="pagination-controls-bottom" class="flex justify-between items-center mt-4 pt-2 border-t border-gray-100"></div>
                    </div>
                </div>`;
        }

    function openDetail(firestoreId) {
            currentEditingId = firestoreId;
            const call = calls.find(c => c.firestoreId === firestoreId);
            if(!call) return;
            
            // Remplissage Lecture Seule
            document.getElementById('modal-client').innerText = call.client || '-';
            document.getElementById('modal-code').innerText = call.code || '-';
            document.getElementById('modal-date').innerText = call.dateCall || '-';
            document.getElementById('modal-agent').innerText = `Traité par : ${call.agentEmail || 'Inconnu'}`;
            document.getElementById('modal-cat').innerText = call.cat || call.category || '-';
            document.getElementById('modal-sub').innerText = call.sub || '-';
            document.getElementById('modal-cr').innerText = call.cr || "Aucune note.";
            
            // Reset du formulaire d'édition
            document.getElementById('edit-note').value = "";
            
            // Pré-cocher le bon statut
            const currentStatus = call.status || call.statut || 'En cours';
            const radios = document.getElementsByName('edit-status');
            radios.forEach(r => {
                r.checked = (r.value === currentStatus);
            });
            
            // Affichage
            const modal = document.getElementById('detailModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
        }

        async function saveCallUpdate() {
            if(!currentEditingId) return;
            
            // Récupérer le nouveau statut
            const radios = document.getElementsByName('edit-status');
            let newStatus = null;
            radios.forEach(r => { if(r.checked) newStatus = r.value; });
            
            if(!newStatus) { alert("Veuillez sélectionner un statut."); return; }

            // Récupérer la note ajoutée
            const newNote = document.getElementById('edit-note').value.trim();
            
            // Mise à jour Firestore
            try {
                const callRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'calls', currentEditingId);
                
                const updateData = { status: newStatus }; // On met à jour 'status' (standardisé)
                
                // Si une note est ajoutée, on l'ajoute au CR existant avec un saut de ligne
                if(newNote) {
                    // On récupère l'ancien CR depuis le DOM ou la liste locale
                    const oldCR = document.getElementById('modal-cr').innerText;
                    const timestamp = new Date().toLocaleString('fr-FR');
                    const separator = oldCR === "Aucune note." ? "" : "\n\n";
                    updateData.cr = `${oldCR === "Aucune note." ? "" : oldCR}${separator}[${timestamp}] ${newNote}`;
                }

                await window.updateDoc(callRef, updateData);
                
                // Feedback et fermeture
                closeDetail();
                // Pas besoin de recharger, le listener onSnapshot le fera automatiquement
                
            } catch (e) {
                console.error("Erreur update:", e);
                alert("Erreur lors de la sauvegarde : " + e.message);
            }
        }

        function closeDetail() {
    
            const modal = document.getElementById('detailModal');
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        /* Style pour masquer proprement */
        .hidden { display: none !important; }
    </style>


    <script>
                let appSettings = {};
// --- SÉCURITÉ : DÉFINITION PRÉALABLE ---
        // Ces fonctions vides empêchent les erreurs "Not Defined" si l'utilisateur
        // interagit avec la page avant le chargement complet des modules.
        window.onSearchFocus = function() { console.log("Chargement en cours..."); };
        window.filterCentres = function() { };
        window.toggleSingleSelection = function() { };
        window.validateSelection = function() { };
        window.toggleSelectAll = function() { };
        // // window.handleExternalContact = function() { }; (Définition déplacée)(Supprimé)

// --- GESTION DES APPLICATIONS (LISTE STATIQUE) ---
window.populateAppSelect = function() {
    const appSelect = document.getElementById('select-app');
    if (!appSelect) return;

    // Réinitialisation de la liste déroulante
    appSelect.innerHTML = '<option value="">-- Sélectionner --</option>';

    // Remplissage avec les clés de appSettings
    if (window.appSettings) {
        const sortedApps = Object.keys(window.appSettings).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
        sortedApps.forEach(app => {
            // Mise en majuscule de la première lettre
            const displayApp = app.charAt(0).toUpperCase() + app.slice(1);
            appSelect.innerHTML += `<option value="${app}">${displayApp}</option>`;
        });
    }
    // On appelle aussi updateCategoryOptions pour s\'assurer que la catégorie est vide
    window.updateCategoryOptions();
};;

window.updateCategoryOptions = function() {
    const appSelect = document.getElementById('select-app');
    const catSelect = document.getElementById('select-cat');
    
    if (!appSelect || !catSelect) return;

    const selectedApp = appSelect.value;
    const categories = window.appSettings[selectedApp] || []; 

    catSelect.innerHTML = '<option value="">-- Sélectionner --</option>';

    if (categories.length > 0) {
        catSelect.disabled = false;
        categories.sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })); // Tri alphabétique
        categories.forEach(cat => {
            // Mise en majuscule de la première lettre
            const displayCat = cat.charAt(0).toUpperCase() + cat.slice(1);
            catSelect.innerHTML += `<option value="${cat}">${displayCat}</option>`;
        });
    } else {
        catSelect.disabled = true; 
    }
};
    // window.loadAppSettings = function() { console.log("Attente module..."); }; (Supprimé)
    </script>
    
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden font-sans">

    
    <div id="loading-overlay" class="fixed inset-0 z-[200] bg-white/95 backdrop-blur-md hidden flex flex-col items-center justify-center transition-all duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100 flex flex-col items-center text-center transform scale-100 transition-transform">
            <div class="mb-6 relative">
                <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center relative z-10">
                     <i class="ph ph-circle-notch text-3xl text-[#F58220] animate-spin"></i>
                </div>
                <div class="absolute inset-0 bg-orange-100 rounded-full animate-ping opacity-20"></div>
            </div>
            
            <h2 class="text-xl font-bold text-gray-800 tracking-tight mb-1">Initialisation</h2>
            <p class="text-xs text-gray-400 mb-6 font-medium uppercase tracking-wide">Veuillez patienter...</p>
            
            <div id="loading-steps" class="w-full space-y-3 text-left pl-2">
                </div>
        </div>
    </div>
    
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-gray-800/90 backdrop-blur-sm flex items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-[400px] relative border border-gray-200">
            
            <div class="flex flex-col items-center mb-6">
                <div class="w-60 h-auto mb-6 flex items-center justify-center">
                    <img src="Logo.png" alt="Logo SGS" class="object-contain w-full">
                </div>
                <h2 class="text-xl font-bold text-gray-800 tracking-tight uppercase text-center text-lg leading-tight">Application de saisie<br>et de suivi des appels</h2>
                <div class="h-1 w-12 bg-[#F58220] mt-4 rounded-full"></div>
            </div>

            
            <form id="loginForm" class="space-y-5">
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Adresse Email</label>
                    <div class="flex shadow-sm rounded-lg">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="ph ph-user text-gray-400"></i>
                            </div>
                            <input type="text" id="auth-username" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-l-lg border-r-0 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-[#F58220] focus:border-[#F58220] sm:text-sm transition-all bg-gray-50 focus:bg-white" placeholder="prenom.nom" required>
                        </div>
                        <div class="bg-gray-100 border border-gray-300 border-l-0 rounded-r-lg px-3 flex items-center text-gray-500 font-bold text-sm select-none shrink-0">
                            @sgs.com
                        </div>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Mot de passe</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ph ph-lock text-gray-400 group-focus-within:text-[#F58220] transition-colors"></i>
                        </div>
                        <input type="password" id="auth-password" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-[#F58220] focus:border-[#F58220] sm:text-sm transition-all bg-gray-50 focus:bg-white" placeholder="••••••••" required>
                    </div>
                </div>

                <div id="auth-error" class="hidden animate-pulse">
                    <div class="flex items-center gap-2 text-red-600 text-xs font-bold bg-red-50 p-3 rounded-lg border border-red-100">
                        <i class="ph ph-warning-circle text-lg"></i>
                        <span>Identifiants incorrects</span>
                    </div>
                </div>

                <button type="submit" class="w-full flex justify-center py-3.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-[#F58220] hover:bg-[#d1650b] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F58220] transition-all active:scale-[0.98]">
                    <span id="btn-text">SE CONNECTER</span>
                    <i id="btn-spinner" class="ph ph-spinner animate-spin hidden ml-2"></i>
                </button>
            </form>
    

            
        </div>
    </div>
    
    <aside class="w-64 shrink-0 bg-white border-r border-gray-200 flex flex-col z-10 shadow-sm">
        <div class="p-4 flex justify-center border-b border-gray-100">
            <div class="w-48 h-auto rounded-xl overflow-hidden flex items-center justify-center bg-white transition-transform hover:scale-105">
                <img src="Logo.png" alt="Logo" class="w-full h-auto object-contain">
            </div>
        </div>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">

            <button onclick="navigate('entry')" id="btn-entry" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors">
                <i class="ph ph-phone-plus text-lg"></i> Nouvel Appel
            </button>
            <button onclick="navigate('dashboard')" id="btn-dashboard" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors">
                <i class="ph ph-chart-pie-slice text-lg"></i> Tableau de Bord
            </button>
            <button onclick="navigate('history')" id="btn-history" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors">
                <i class="ph ph-clock-counter-clockwise text-lg"></i> Historique
            </button>
            <button onclick="navigate('followup')" id="btn-followup" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors">
                <i class="ph ph-list-checks text-lg"></i> Suivi des Actions
                <span id="badge-todo" class="hidden ml-auto bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">!</span>
            </button>
            <button onclick="navigate('documentation')" id="btn-documentation" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-gray-50 text-[#9fa0a2] transition-colors">
                <i class="ph ph-book-open text-lg"></i> Documentation
            </button>

        </nav>
        
            
            <div class="p-4 border-t border-gray-100 mt-2">
            
            <button id="logout-btn"  class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-red-50 text-red-500 transition-colors border border-transparent hover:border-red-100">
                <i class="ph ph-sign-out text-lg"></i> Déconnexion
            </button>
        </div>
    </aside>

    <div class="hidden bg-white p-4 flex justify-between items-center border-b border-gray-200 sticky top-0 z-20 blur-sm pointer-events-none transition-all duration-300">
        <img src="logo.png" alt="Logo" class="h-8 w-auto">
        <button id="mobile-menu-trigger" class="p-2 text-gray-600 rounded-lg hover:bg-gray-100">
            <i class="ph ph-list text-2xl"></i>
        </button>
    </div>

    <div id="mobile-sidebar" class="fixed inset-0 z-30 hidden">
        <div class="absolute inset-0 bg-black/50" onclick="toggleMobileMenu()"></div>
        <aside class="absolute left-0 top-0 bottom-0 w-64 shrink-0 bg-white shadow-xl flex flex-col">
            <div class="p-6 flex justify-between items-center border-b border-gray-100">
                <span class="font-bold text-lg text-[#F58220]">Menu</span>
                <button onclick="toggleMobileMenu()"><i class="ph ph-x text-xl"></i></button>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="navigate('entry');toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50"><i class="ph ph-phone-plus text-lg"></i> Nouvel Appel</button>
                <button onclick="navigate('dashboard');toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50"><i class="ph ph-chart-pie-slice text-lg"></i> Tableau de Bord</button>
                <button onclick="navigate('history');toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50"><i class="ph ph-clock-counter-clockwise text-lg"></i> Historique</button>
                <button onclick="navigate('followup');toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50"><i class="ph ph-list-checks text-lg"></i> Suivi des Actions</button>
                <button onclick="navigate('documentation');toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50"><i class="ph ph-book-open text-lg"></i> Documentation</button>
                
                <button id="mobile-logout-btn"  class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-red-500 hover:bg-red-50 mt-4"><i class="ph ph-sign-out text-lg"></i> Déconnexion</button>
            </nav>
        </aside>
    </div>

    <main class="flex-1 flex flex-col h-full relative bg-gray-50/50 blur-sm pointer-events-none transition-all duration-300">
        <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8"></div>
    </main>

    
    <div id="detailModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center fade-in backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-gray-200 flex flex-col max-h-[90vh]">
            
            <div class="bg-[#F58220] p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="ph ph-pencil-simple-line"></i> Traitement du Dossier</h3>
                <button onclick="closeDetail()" class="hover:bg-white/20 rounded-full p-1 transition"><i class="ph ph-x text-xl"></i></button>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto">
                <div class="flex justify-between items-start border-b border-gray-100 pb-4">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Client / Centre</p>
                        <p class="font-bold text-xl text-[#76787B]" id="modal-client">-</p>
                        <p class="text-sm font-mono text-[#F58220]" id="modal-code">-</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-gray-400 uppercase">Date & Collab.</p>
                        <p class="font-bold text-gray-800" id="modal-date">-</p>
                        <p class="text-xs text-gray-500 italic mt-1" id="modal-agent">-</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs font-bold text-gray-400 uppercase">Catégorie</p><p class="font-medium text-gray-700" id="modal-cat">-</p></div>
                    <div><p class="text-xs font-bold text-gray-400 uppercase">Sous-catégorie</p><p class="font-medium text-gray-700" id="modal-sub">-</p></div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                    <p class="text-xs font-bold text-[#F58220] uppercase mb-2 flex items-center gap-1"><i class="ph ph-note-pencil"></i> Historique du Compte Rendu</p>
                    <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap" id="modal-cr">Aucun contenu.</p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 border border-orange-200 mt-4">
                    <h4 class="text-sm font-bold text-orange-800 uppercase mb-3 flex items-center gap-2"><i class="ph ph-gear"></i> Actions & Mise à jour</h4>
                    
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Nouveau Statut</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="edit-status" value="Clôturé" class="peer hidden">
                            <div class="p-2 text-center rounded-lg bg-white border border-gray-200 text-gray-500 hover:bg-green-50 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500 peer-checked:font-bold transition-all text-xs">Clôturé</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="edit-status" value="En cours" class="peer hidden">
                            <div class="p-2 text-center rounded-lg bg-white border border-gray-200 text-gray-500 hover:bg-blue-50 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 peer-checked:font-bold transition-all text-xs">En cours</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="edit-status" value="À traiter" class="peer hidden">
                            <div class="p-2 text-center rounded-lg bg-white border border-gray-200 text-gray-500 hover:bg-orange-50 peer-checked:bg-orange-400 peer-checked:text-white peer-checked:border-orange-400 peer-checked:font-bold transition-all text-xs">À traiter</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="edit-status" value="À rappeler" class="peer hidden">
                            <div class="p-2 text-center rounded-lg bg-white border border-gray-200 text-gray-500 hover:bg-red-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 peer-checked:font-bold transition-all text-xs">À Rappeler</div>
                        </label>
                    </div>

                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Ajouter une note (Optionnel)</label>
                    <textarea id="edit-note" rows="2" class="w-full p-3 rounded-lg border border-gray-300 focus:border-orange-500 focus:ring-1 focus:ring-orange-200 outline-none text-sm" placeholder="Ex: Client rappelé, dossier clos..."></textarea>
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center shrink-0">
                <button onclick="closeDetail()" class="text-gray-500 hover:text-gray-700 font-medium text-sm">Annuler</button>
                <button onclick="saveCallUpdate()" class="px-6 py-2 bg-[#F58220] text-white font-bold rounded-lg hover:bg-[#d9731c] transition flex items-center gap-2 shadow-md shadow-orange-100">
                    <i class="ph ph-floppy-disk"></i> Sauvegarder
                </button>
            </div>
        </div>
    </div>
    

    <script type="module">

    // --- IMPORTS FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, getDoc, getDocs, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    
    // --- Correction ReferenceError ---
    // const appSettings est déportée dans la portée globale (window.appSettings) par le code initial.
// --- SECURITE AMELIOREE : La configuration devrait être chargée depuis un fichier .env ou un backend ---
function getFirebaseConfig() {
    const firebaseConfig = {
          apiKey: "AIzaSyDHljgMTJUNFxixyGCNmHa5x3C50pC3S2w",
          authDomain: "centre-appels.firebaseapp.com",
          projectId: "centre-appels",
          storageBucket: "centre-appels.firebasestorage.app",
          messagingSenderId: "127271081032",
          appId: "1:127271081032:web:782416a501242cd353f47d",
          measurementId: "G-R28JM1CJEX"
        };
    return firebaseConfig;
}

        // Initialize Firebase
        const app = initializeApp(getFirebaseConfig());
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        
        // Ajout de l'ID pour le nouvel overlay
        const loadingOverlay = document.getElementById('loading-overlay');

    // --- PERSISTANCE SESSION ---
    setPersistence(auth, browserSessionPersistence)
      .then(() => {
         console.log("Mode de persistance : SESSION");
      })
      .catch((error) => {
        console.error("Erreur persistance :", error);
      });
        const db = getFirestore(app);
        const appId = 'centre-appels'; 
        
        // Exposition de db et appId à la portée globale
        window.db = db;
        window.appId = appId;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        
    // --- LOGIQUE UX : CHIPS / TAGS (Bloc redondant supprimé) ---
    
window.getDoc = getDoc;


        window.getDocs = getDocs;
        window.collection = collection;



        // Éléments UI
        const authOverlay = document.getElementById('auth-overlay');
        const loginForm = document.getElementById('loginForm');
        const errorMsg = document.getElementById('auth-error');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const userDisplay = document.getElementById('user-display');
        const appElements = document.querySelectorAll('body > aside, body > .sticky, body > #mobile-sidebar, body > main');

        // Fonction pour mettre à jour le statut du spinner
        
        // Fonction pour mettre à jour le statut du spinner (Version UI Améliorée)
        window.updateSpinnerStep = function(id, text, isDone = false) {
            const container = document.getElementById('loading-steps');
            let step = document.getElementById(id);
            
            if (!step) {
                // Création de l'étape
                const div = document.createElement('div');
                div.id = id;
                div.className = "flex items-center gap-3 text-sm text-gray-500 transition-all duration-300 transform translate-x-0 opacity-0 animate-fade-in-right";
                // Petite animation d'entrée via style direct pour l'exemple, ou classe CSS si dispo
                div.style.animation = "slideIn 0.3s forwards";
                
                div.innerHTML = `
                    <div class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-100 shrink-0 transition-colors duration-300" id="${id}-bg">
                        <i class="ph ph-circle-notch animate-spin text-xs text-gray-400" id="${id}-icon"></i>
                    </div>
                    <span class="font-medium" id="${id}-text">${text}</span>
                `;
                container.appendChild(div);
                // Force reflow pour l'animation
                void div.offsetWidth; 
                div.style.opacity = "1";
            } else {
                // Mise à jour
                const textEl = document.getElementById(`${id}-text`);
                const iconEl = document.getElementById(`${id}-icon`);
                const bgEl = document.getElementById(`${id}-bg`);
                
                if (textEl) textEl.innerText = text;
                
                if (isDone) {
                    if (iconEl) {
                        iconEl.className = "ph ph-check text-xs text-white";
                    }
                    if (bgEl) {
                        bgEl.classList.remove('bg-gray-100');
                        bgEl.classList.add('bg-green-500', 'scale-110');
                    }
                    step.classList.add('text-green-700');
                } else {
                     // Cas d'erreur ou en cours (si on réutilise)
                     if (text.includes('Erreur')) {
                         if(iconEl) iconEl.className = "ph ph-warning text-xs text-white";
                         if(bgEl) { bgEl.className = "w-6 h-6 rounded-full flex items-center justify-center bg-red-500 shrink-0"; }
                         step.classList.add('text-red-600');
                     }
                }
            }
        };

        // --- NOUVEAU PROCESSUS DE CHARGEMENT SÉQUENTIEL ---
        function startLoadingProcess(user) {
            loadingOverlay.classList.remove('hidden');
            
            // Étape 1: Vérification du compte (déjà fait par Firebase)
            window.updateSpinnerStep('step-auth', 'Authentification utilisateur OK.', true); // Authentification réussie

            // Étape 2: Lancement du chargement des données (asynchrone)
            Promise.all([
                window.preloadCentresData(),
                
            ]).then(() => {
                // Toutes les données sont prêtes
                window.updateSpinnerStep('step-data-check', 'Vérification des données métiers : OK', true);
                // Terminer et masquer l'overlay après un court délai
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden'); // Masque le spinner
                    toggleAppVisibility(true); // Affiche l'application (enlève le blur et pointer-events)
                    // On appelle navigate('entry') après le chargement
                    navigate('entry'); 
                }, 2500);

            }).catch(error => {
                console.error("Erreur critique au chargement des données:", error);
                window.updateSpinnerStep('step-data-check', `Erreur critique: ${error.message}. Rechargez.`, false);
                // Afficher l'erreur mais laisser l'application masquée
            });
        }

        
    // --- SYSTÈME DE PRÉSENCE TEMPS RÉEL (MULTI-UTILISATEURS) ---
    window.presenceInterval = null;

    async function startPresenceSystem(user) {
        const userStatusRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'presence', user.uid);
        const presenceCollection = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'presence');

        // 1. Fonction pour dire "Je suis là" (Heartbeat)
        const sendHeartbeat = async () => {
            try {
                await window.setDoc(userStatusRef, {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    last_seen: Date.now(),
                    state: 'online'
                }, { merge: true });
            } catch (e) { console.error("Err heartbeat:", e); }
        };

        // Envoyer immédiatement puis toutes les 60 secondes
        sendHeartbeat();
        if (window.presenceInterval) clearInterval(window.presenceInterval);
        window.presenceInterval = setInterval(sendHeartbeat, 60000);

        // 2. Écouter les autres (Mise à jour de la liste)
        window.onSnapshot(presenceCollection, (snapshot) => {
            const usersList = document.getElementById('connected-users-list');
            if (!usersList) return;

            usersList.innerHTML = ''; // Reset
            const now = Date.now();
            let activeCount = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                // On considère "En ligne" si vu il y a moins de 2 minutes
                const isOnline = (now - data.last_seen) < (2 * 60 * 1000);

                if (isOnline) {
                    activeCount++;
                    const isMe = (doc.id === user.uid);
                    const name = data.email.split('@')[0].replace('.', ' '); // Format "prenom nom"
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 text-xs font-medium text-gray-700 animate-fade-in';
                    div.innerHTML = `
                        <div class="relative">
                            <div class="w-2 h-2 rounded-full ${isMe ? 'bg-green-500' : 'bg-blue-500'}"></div>
                            ${isMe ? '<div class="absolute inset-0 rounded-full bg-green-500 animate-ping opacity-50"></div>' : ''}
                        </div>
                        <span class="truncate capitalize" title="${data.email}">
                            ${isMe ? 'Moi' : name}
                        </span>
                    `;
                    usersList.appendChild(div);
                }
            });

            if (activeCount === 0) {
                usersList.innerHTML = '<span class="text-xs text-gray-400 italic">Personne en ligne</span>';
            }
        });
    }

    // Gestion de l'état de connexion (MODIFIÉ)
        onAuthStateChanged(auth, (user) => {
            if (user) { 
                window.currentUser = user;
                const userSpan = document.getElementById('user-email-span');
                
                // --- SYSTÈME DE PRÉSENCE ---
                // startPresenceSystem(user); // Désactivé
    

                if(userSpan) userSpan.innerText = user.email;
                
                // --- NOUVEAU : Lance le processus de chargement ---
                startFirestoreListener(); // Lance l'écouteur
                startLoadingProcess(user);

            } else {
                window.currentUser = null;
                toggleAppVisibility(false);
                loadingOverlay.classList.add('hidden'); // Masquer si déconnecté
            }
        });

        // Toggle UI
        function toggleAppVisibility(show) {
            if(show) {
                authOverlay.classList.add('hidden');
                appElements.forEach(el => el.classList.remove('blur-sm', 'pointer-events-none'));
            } else {
                authOverlay.classList.remove('hidden');
                appElements.forEach(el => el.classList.add('blur-sm', 'pointer-events-none'));
            }
        }

        // Login Manuel
        
        // Login Manuel Optimisé
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-username').value.trim() + '@sgs.com';
            const password = document.getElementById('auth-password').value;

            // UI : État chargement bouton
            errorMsg.classList.add('hidden');
            const btn = loginForm.querySelector('button[type="submit"]');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin text-xl"></i> Connexion...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    // Succès : Transition immédiate vers l'écran de chargement
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    // Le onAuthStateChanged prendra le relais pour lancer startLoadingProcess
                })
                .catch((error) => {
                    let msg = "Erreur de connexion.";
                    if(error.code.includes('invalid-credential') || error.code.includes('wrong-password')) msg = "Identifiants incorrects.";
                    errorMsg.innerHTML = `<i class="ph ph-warning-circle text-lg"></i> <span>${msg}</span>`;
                    errorMsg.classList.remove('hidden');
                    
                    // Reset bouton
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                });
        });

        // Logout
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        document.getElementById('mobile-logout-btn').onclick = () => signOut(auth);

        // --- FIRESTORE : ÉCOUTE TEMPS RÉEL ---
        function startFirestoreListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'calls');
            
            onSnapshot(q, (snapshot) => {
                calls = []; 
                snapshot.forEach((doc) => {
                    calls.push({ firestoreId: doc.id, ...doc.data() });
                });
                
                const currentView = document.getElementById('btn-entry').classList.contains('bg-[#fef8f3]') ? 'entry' :
                                    document.getElementById('btn-dashboard').classList.contains('bg-[#fef8f3]') ? 'dashboard' : document.getElementById('btn-followup').classList.contains('bg-[#fef8f3]') ? 'followup' : 'history';
                
                
                // Mise à jour du badge
                const todoCount = calls.filter(c => ['En cours', 'À traiter', 'À rappeler'].includes(c.status || c.statut)).length;
                const badge = document.getElementById('badge-todo');
                if(badge) {
                    if(todoCount > 0) { badge.classList.remove('hidden'); badge.innerText = todoCount; }
                    else { badge.classList.add('hidden'); }
                }

                if(window.populateCollabList) window.populateCollabList();
                if(currentView !== 'entry') navigate(currentView);
            
                
            }, (error) => {
                console.error("Erreur Firestore:", error);
            });
        }

        // 2. Fonction pour charger les infos dirigeant
        async function loadDirigeantInfo(nomComplet) {
            const box = document.getElementById('dirigeant-info-box');
            if(!nomComplet) { box.classList.add('hidden'); return; }

            const parts = nomComplet.toUpperCase().split(' ').filter(p => p.length > 0);
            let searchKey = parts.join('_').replace(/[^A-Z0-9_]/g, '');
            
            console.log("Recherche dirigeant : " + searchKey);

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'dirigeants', searchKey);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('dir_mobile').value = data.mobile || data.tel || '-';
                    document.getElementById('dir_email').value = data.email || '-';
                    document.getElementById('dir_adresse').value = (data.adresse || '') + ' ' + (data.cp || '') + ' ' + (data.ville || '');
                    box.classList.remove('hidden');
                } else {
                    console.log("Dirigeant non trouvé dans la base détaillée.");
                    box.classList.add('hidden');
                }
            } catch (e) {
                console.error("Erreur lecture dirigeant", e);
            }
        }

        // --- CORRECTIF AUTO : Rendre la fonction accessible au HTML ---
        window.loadDirigeantInfo = loadDirigeantInfo;

        // GESTION DU FORMULAIRE D'APPEL
        document.addEventListener('submit', async (e) => {
            // CORRECTION BUG ID : 'callForm' au lieu de 'entryForm'
            if(e.target && e.target.id === 'callForm') {
                e.preventDefault();
                const btn = document.querySelector('#callForm button[type="submit"]');
                
                if(!window.currentUser) { alert("Vous devez être connecté."); return; }
                
                const fd = new FormData(e.target);
                const clientVal = document.getElementById('field_client').value;
                if(!clientVal) { alert("Code centre invalide ou non chargé."); return; }

                
                if (!window.callDirection) { 
                    alert('Veuillez spécifier la direction de l\'appel (Entrant/Sortant).'); 
                    btn.disabled = false;
                    return; 
                }
const obj = Object.fromEntries(fd.entries());
                
                // Ajout des métadonnées
                // --- MISE À JOUR POUR MONO-CENTRE ---
                // Le code centre est pris de la variable globale currentSelectedCode, 
                // ou du champ si c'est un Contact Externe.
                obj.code = window.currentSelectedCode || document.getElementById('code-centre').value || 'N/A';
                // ------------------------------------
                obj.direction = window.callDirection; // Ajout du champ direction

    
                obj.client = clientVal;
                obj.agentId = window.currentUser.uid;
                obj.agentEmail = window.currentUser.email;
                obj.timestamp = Date.now();
                obj.dateCall = new Date().toLocaleString('fr-FR');

                // UI Loading
                const originalText = btn.innerText;
                btn.innerText = "Sauvegarde en cours...";
                btn.disabled = true;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calls'), obj);
                    // alert("Appel enregistré !"); // Popup retiré
                    navigate('entry');
                } catch (error) {
                    console.error("Erreur ajout:", error);
                    alert("Erreur lors de la sauvegarde: " + error.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        });

        // Lancer la vue par défaut
        // NOTE: Ceci est lancé par startLoadingProcess après le chargement initial

        
// --- MOTEUR DE RECHERCHE INTELLIGENT (AJOUT AUTO) ---
    
    let cachedCentresList = []; 
    // Variable pour stocker le code du centre actuellement sélectionné
    let currentSelectedCode = null; 

    // Préchargement des données pour une recherche rapide
    window.preloadCentresData = async function() {
        if (cachedCentresList.length > 0) {
             window.updateSpinnerStep('step-centres', 'Centres de services chargés (Cache)', true);
             return;
        }
        try {
            window.updateSpinnerStep('step-centres', 'Chargement des centres de services...');
            
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'centres');
            const snapshot = await getDocs(colRef);
            cachedCentresList = snapshot.docs.map(doc => ({ code: doc.id, ...doc.data() }));
            
            window.updateSpinnerStep('step-centres', `Centres de services chargés (${cachedCentresList.length} trouvés)`, true);
        } catch (e) { 
            window.updateSpinnerStep('step-centres', 'Erreur au chargement des centres', false);
            console.error("Erreur cache:", e); 
        }
    };

    
    // Nouvelle fonction au focus : filtre uniquement
    window.onSearchFocus = function(input) {
        filterCentres(input.value);
    };

    // Fonction de filtrage (Code OU Nom OU Dirigeant) - Mode Mono-Centre
    window.filterCentres = function(text) {
        const box = document.getElementById('suggestions-box');
        const inputVal = text ? text.trim().toUpperCase() : "";
        
        // Cacher si moins de 2 caractères
        if (inputVal.length < 2) {
            box.classList.add('hidden'); 
            return; 
        }

        if(!cachedCentresList) return; 
        
        const results = cachedCentresList.filter(c => {
            const codeMatch = c.code.toUpperCase().includes(inputVal);
            const nameMatch = (c.nom || "").toUpperCase().includes(inputVal);
            const dirMatch = (c.dirigeant || "").toUpperCase().includes(inputVal);
            const cityMatch = (c.ville || "").toUpperCase().includes(inputVal);
            return codeMatch || nameMatch || dirMatch || cityMatch;
        });

        renderSuggestionsBox(results);
    };
    

    // Rendu HTML de la boite de suggestions (Mono-Centre)
    function renderSuggestionsBox(results) {
        const box = document.getElementById('suggestions-box');
        
        if (results.length === 0) {
            box.innerHTML = `<div class="p-3 text-gray-400 italic text-sm">Aucun résultat.</div>`;
            box.classList.remove('hidden');
            return;
        }

        // Liste des résultats
        let html = results.slice(0, 10).map(c => { // Limite à 10 résultats
            return `
                <div onclick="toggleSingleSelection('${window.escapeHTML(c.code).replace(/[']/g, "\\'")}', event)" 
                    class="p-3 border-b border-gray-50 hover:bg-orange-50 cursor-pointer transition flex items-center gap-3 text-left">
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-700">${window.escapeHTML(c.code)}</span>
                            <span class="text-xs text-gray-400 pl-1">${c.dirigeant ? '<i class="ph ph-user"></i> ' + c.dirigeant : ''}</span>
                        </div>
                        <div class="text-sm text-gray-600 truncate">${window.escapeHTML(c.nom) || 'Sans nom'} - ${window.escapeHTML(c.ville) || 'Ville inconnue'}</div>
                    </div>
                </div>
            `;
        }).join('');

        box.innerHTML = html;
        box.classList.remove('hidden');
    }

    // Gestion du click sur une ligne (Sélectionne et valide le centre)
    window.toggleSingleSelection = function(code, event) {
        if(event) {
            event.preventDefault();
            event.stopPropagation();
        }

        currentSelectedCode = code; // Stocke le code sélectionné
        
        // 1. Remplir le champ de recherche
        const input = document.getElementById('code-centre');
        input.value = code; 

        // 2. Valider et remplir le formulaire
        validateSelection(code);

        // 3. Cacher la boîte de suggestions
        document.getElementById('suggestions-box').classList.add('hidden');
    };
    
    // Validation finale et remplissage (Mono-Centre)
    window.validateSelection = function(code) {
        
        if (!code) return;

        // Reset UI (Cache la boite de suggestion)
        document.getElementById('suggestions-box').classList.add('hidden');
        // Suppression de la réinitialisation du select Contact Externe
        
        // Show Sections (Force l'affichage des sections Centre, Dirigeants et CR)
        document.getElementById('section-centre-info').classList.remove('hidden');
        document.getElementById('section-dirigeants').classList.remove('hidden');
        document.getElementById('section-cr').classList.remove('hidden');
        document.getElementById('btn-submit').classList.remove('hidden');

        // Appel de la fonction pour remplir le formulaire
        window.fillSingleCentre(code);
    };

    // Fonction de remplissage des champs à partir du code (Mono-Centre)
    window.fillSingleCentre = function(code) {
         // updateHistoryPreview est défini ailleurs, mais on l'appelle ici
         if (window.updateHistoryPreview) window.updateHistoryPreview(code); 
         
         const centre = cachedCentresList.find(c => c.code === code);
         if (centre) {
            // Mise à jour de la variable globale au cas où le formulaire doit la lire
            currentSelectedCode = code; 
            
            const fields = ['reseau', 'client', 'adresse', 'cp', 'ville', 'telephone', 'email', 'dirigeant', 'exploitant', 'rr', 'auditeur'];
            
            // Mise à jour du nom commercial (Nom Client)
            if(document.getElementById('field_client')) document.getElementById('field_client').value = centre.nom || '';
            
            fields.forEach(f => {
                let key = f; if(f === 'telephone') key = 'tel'; if(f === 'client') key = 'nom';
                const el = document.getElementById('field_' + f); if(el) el.value = centre[key] || '';
            });
            
            if(centre.dirigeant && window.loadDirigeantInfo) window.loadDirigeantInfo(centre.dirigeant);
            else document.getElementById('dirigeant-info-box')?.classList.add('hidden');
        } else {
             // Nettoyer les champs si le code n'est pas trouvé (sécurité)
             const fields = ['reseau', 'client', 'adresse', 'cp', 'ville', 'telephone', 'email', 'dirigeant', 'exploitant', 'rr', 'auditeur'];
             fields.forEach(f => {
                 const el = document.getElementById('field_' + f);
                 if(el) el.value = '';
             });
        }
    };
    
    // Redirection pour compatibilité si nécessaire
    window.selectCentreFromList = window.fillSingleCentre;
    

    // Fermeture de la liste au clic extérieur
    document.addEventListener('click', function(e) {
        const box = document.getElementById('suggestions-box');
        const input = document.getElementById('code-centre');
        if (box && !box.contains(e.target) && e.target !== input) { box.classList.add('hidden'); }
    });


    // --- AJOUT DE LA FONCTION MANQUANTE POUR LE PARAMÉTRAGE/SELECT ---
    
    
    // --- GESTION PARAMÉTRAGE (Applications & Catégories) ---
    
    // Chargement des settings depuis Firestore (simulé ou réel)
    

    function renderAppCard(app) {
        const cats = window.appSettings[app] || [];
        return `
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden group">
            <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-gray-700">${app}</h3>
                <button onclick="deleteApp('${app}')" class="text-red-400 hover:text-red-600 p-1"><i class="ph ph-trash"></i></button>
            </div>
            <div class="p-4">
                <ul class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    ${cats.map((cat, index) => `
                        <li class="flex justify-between items-center text-sm bg-gray-50 px-3 py-2 rounded-lg">
                            <span>${cat}</span>
                            <button onclick="deleteCategory('${app}', ${index})" class="text-gray-400 hover:text-red-500"><i class="ph ph-x"></i></button>
                        </li>
                    `).join('')}
                    ${cats.length === 0 ? '<li class="text-xs text-gray-400 italic">Aucune catégorie</li>' : ''}
                </ul>
                <div class="flex gap-2">
                    <input type="text" id="new-cat-${app.replace(/\s/g, '')}" class="flex-1 p-2 border rounded-lg text-sm outline-none focus:border-orange-500" placeholder="Nouvelle catégorie...">
                    <button onclick="addCategory('${app}')" class="bg-gray-100 text-gray-600 px-3 rounded-lg hover:bg-gray-200"><i class="ph ph-plus"></i></button>
                </div>
            </div>
        </div>
        `;
    }

    



    



// --- REMPLACEMENT DU DUBLON PAR LA SAUVEGARDE EN TEMPS RÉEL ---




    
</script>

</body>
</html>